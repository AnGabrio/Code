<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrea Gabrio">
<meta name="dcterms.date" content="2025-11-18">

<title>Statistical methods for model-based HTA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="code3_files/libs/clipboard/clipboard.min.js"></script>
<script src="code3_files/libs/quarto-html/quarto.js"></script>
<script src="code3_files/libs/quarto-html/popper.min.js"></script>
<script src="code3_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="code3_files/libs/quarto-html/anchor.min.js"></script>
<link href="code3_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="code3_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="code3_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="code3_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="code3_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Statistical methods for model-based HTA</h1>
<p class="subtitle lead">Part II</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://angabrio.github.io/agabriosite2/">Andrea Gabrio</a> <a href="mailto:a.gabrio@maastrichtuniversity.nl" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-7650-4534" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://www.maastrichtuniversity.nl/research/methodology-and-statistics">
            Maastricht University
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 18, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>This document provides the full code used to simulate some artificial model-based HTA data and implement different types of statistical methods to analyse them. The methods listed here are based on a selection made according to recommendations from the current literature <span class="citation" data-cites="el2022scoping">(<a href="#ref-el2022scoping" role="doc-biblioref">El Alili et al. 2022</a>)</span> and national guidelines from the <em>ZorgInstituut Nederland</em><span class="citation" data-cites="nederland2024guideline">(<a href="#ref-nederland2024guideline" role="doc-biblioref">Nederland 2024</a>)</span> about the statistical analysis of (empirical) trial-based health economic evaluations in the Netherlands.</p>
<p>The code is presented with some comments and brief descriptions using an HTML interface generated via <a href="https://quarto.org/"><em>quarto</em></a> and <a href="https://posit.co/download/rstudio-desktop/"><em>Rstudio</em></a> to ease accessibility. The raw code is provided in a separate file in the same <a href="https://github.com/AnGabrio/Code/tree/master/RHTAmethods">GitHub repository</a>.</p>
<section id="sec-ctmm" class="level1">
<h1>Continuous Time Multistate Models</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this section we extend the topics of Markov models, and focus on cohort/individual-level Markov/Semi-Markov multistate models in either discrete or continuous time. We start by introducing continuous-time multistate models, where each individual, at a given time <span class="math inline">\(t\)</span>, is assumed to be in one of the <span class="math inline">\(H\)</span> model health states for a certain amount of time, called the <em>state occupancy</em>, and denoted with <span class="math inline">\(X(t)\)</span><span class="citation" data-cites="jackson2011multi">(<a href="#ref-jackson2011multi" role="doc-biblioref">Jackson 2011</a>)</span>. Transitions between states are governed by the <em>hazard rates</em> or <em>intensities</em> <span class="math inline">\(q_{rs}\)</span> for each source state <span class="math inline">\(r\)</span> and destination state <span class="math inline">\(s\)</span>, where the quantity <span class="math inline">\(q_{rs}(t)\)</span> represents the instantaneous risk of moving from state <span class="math inline">\(r\)</span> to state <span class="math inline">\(s\)</span> at time <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[
q_{rs}(t,z(t))=\lim_{\Delta \rightarrow 0}\frac{\text{Pr}(X(t+\Delta t)=s \mid X(t)=r)}{\Delta t}
\]</span></p>
<p>and may depend on <span class="math inline">\(z(t)\)</span>, a set of individual-level, possibly time-dependent, covariates. The term <span class="math inline">\(q_{rs}\)</span> represents the rate at which transitions from state <span class="math inline">\(r\)</span> to state <span class="math inline">\(s\)</span> occur in a population in state <span class="math inline">\(r\)</span>. Often, these are grouped together into a <em>transition intensity matrix</em> <span class="math inline">\(Q\)</span> of dimensions <span class="math inline">\(H\times H\)</span> and formed from the corresponding <span class="math inline">\(q_{rs}\)</span>, whose rows sum up to zero, ie diagonal entries are <span class="math inline">\(q_{rr}=-\sum_{s\neq r}q_{rs}\)</span>.</p>
<p>The time variable <span class="math inline">\(t\)</span> determining the transition intensity can either represent: 1) time from the start of the model (<em>time-in-model</em>), in which case the model is defined as <em>clock-forward</em>; 2) time since the previous transition (<em>time-in-state</em>), where <span class="math inline">\(t\)</span> is reset to zero at time of entry to a new state, in which case the model is defined as <em>clock-reset</em>. In either case, we assume future disease progression to depend only on time <span class="math inline">\(t\)</span>, the state <span class="math inline">\(X(t)\)</span> and predictors <span class="math inline">\(z(t)\)</span>. However, in the first case, the model is a <em>Markov</em> model since transitions do not depend further on which previous transitions occurred or when they occurred, whereas in the second case the model is a <em>Semi-Markov</em> model since it depends on the history of the process only through the time <span class="math inline">\(t\)</span> of entry to the current state. Further, in a <em>time-homogeneous</em> model <span class="math inline">\(q_{rs}\)</span> are assumed to be independent of time <span class="math inline">\(t\)</span>, with the period spent in state <span class="math inline">\(r\)</span> before transitioning to any other state being exponentially distributed with mean <span class="math inline">\(-\frac{1}{q_{rr}}\)</span>. Disease progression is represented through a sequence of <span class="math inline">\(J\)</span> distinct jumps at any times <span class="math inline">\(t_j\)</span> from state <span class="math inline">\(X(t_j)\)</span> to <span class="math inline">\(X(t_j+1)\)</span> given the history <span class="math inline">\(D=(t_0,X(t_0)),\ldots,(t_J,X(t_J))\)</span>.</p>
<p>Transition intensities in continuous time are different from transition probabilities in discrete time <span class="math inline">\(p_{rs}\)</span>, where the latter describe the probability that a person in state <span class="math inline">\(r\)</span> at the start of the cycle is in state <span class="math inline">\(s\)</span> at the end of a cycle. Instead, in continuous time models, there is no specific cycle length and the transition probabilities <span class="math inline">\(p_{rs}(u)\)</span> over a time period <span class="math inline">\(u\)</span> can be determined as a function of the transition intensities <span class="math inline">\(q_{rs}\)</span><span class="citation" data-cites="jackson2011multi">(<a href="#ref-jackson2011multi" role="doc-biblioref">Jackson 2011</a>)</span>. In general, it is possible to use an individual-level model in continuous time as the basis of a cohort model in discrete time by simply partitioning time into intervals <span class="math inline">\([0,t_1],\ldots,[t_{C-1},t_C]\)</span>, where each of the intervals is a model cycle. Then, within a cohort model, the cohort of individuals would be represented by an <span class="math inline">\(H\times 1\)</span> state vector storing the probability of being in each state for each cycle. If transition intensities <span class="math inline">\(q_{rs}\)</span> are constant over the interval <span class="math inline">\(u=t_{c+1}-t_c\)</span>, then the transition probability matrix can be expressed as the matrix exponential of the intensity matrix</p>
<p><span class="math display">\[
P_c=\text{Exp}(uQ_c),
\]</span> where such matrix is defined by a power series formed from matrix products, as implemented in the <code>R</code> package <code>msm</code><span class="citation" data-cites="jackson2011multi">(<a href="#ref-jackson2011multi" role="doc-biblioref">Jackson 2011</a>)</span>. An alternative approach to the matrix exponential is to use the Aalen-Johansen estimator, as in the <code>R</code> package <code>mstate</code><span class="citation" data-cites="de2011mstate">(<a href="#ref-de2011mstate" role="doc-biblioref">Wreede, Fiocco, and Putter 2011</a>)</span>.</p>
<p>Before showing an application of an individual-level continuous semi-Markov clock-reset model to a case study, it is important to highlight a few features and assumptions about the model type we will implement.</p>
<p>First, we will assume that the transition intensities are estimated using continuously-observed data, where the state occupancy <span class="math inline">\(X(t)\)</span> for each individual is known at all times <span class="math inline">\(t\)</span>. Note that with two states <span class="math inline">\(1\)</span> and <span class="math inline">\(2\)</span> (eg alive and dead), with transitions from <span class="math inline">\(2\)</span> to <span class="math inline">\(1\)</span> not allowed, a continuous-time model is equivalent to a survival or time-to-event model with hazard function <span class="math inline">\(h(t)=q_{12}(t)\)</span>. More generally, the transition rate <span class="math inline">\(q_{rs}(t)\)</span> can be interpreted as the hazard rate for the time until the transition from state <span class="math inline">\(r\)</span> to state <span class="math inline">\(s\)</span>. This means, in practice, that fitting multistate models is equivalent of fitting different time-to-event models for each <span class="math inline">\(r\rightarrow s\)</span> transition time. For clock-forward models, this time is counted from the start of the model, while in clock-reset models it is reset to zero at time of entry to state <span class="math inline">\(r\)</span>. To fit the transition-specific models, the data need to be re-arranged in a form where rows represent either observed or censored <span class="math inline">\(r\rightarrow s\)</span> transitions. Each observed time of transition from state <span class="math inline">\(r\)</span> to state <span class="math inline">\(s\)</span> should be included as a censored time of transition from state <span class="math inline">\(r\)</span> to any other states that act as competing risks to state <span class="math inline">\(s\)</span>, ie states other than <span class="math inline">\(s\)</span> to which that person could transition directly from <span class="math inline">\(r\)</span>. Additionally, in clock-forward models, the time of transition to state <span class="math inline">\(s\)</span> should be left-truncated at the time of entry to state <span class="math inline">\(r\)</span>. Any survival distribution could be used to describe the intensity functions <span class="math inline">\(q_{rs}(t,z(t))\)</span> and, in our case, we will assume that explanatory variables are time-independent and use the <span class="math inline">\(1\rightarrow 2\)</span> parameter distributions implemented in the <code>R</code> package <code>flexsurv</code>.</p>
<p>When <span class="math inline">\(X(t)\)</span> is only known at a finite series of times <span class="math inline">\(t=(t_{i1},\ldots,t_{in_i})\)</span>, often referred to as <em>interval-censored</em> or <em>panel</em> data, it is still possible to estimate transition rates to be used in the multistate model. Due to the lack of some data, some assumptions are needed. A typical practice is to assume the intensities to be time-homogeneous and use an exponential distribution for the time-to-event data. These models are fitted by maximum likelihood, where the contribution to the likelihood from a consecutive pair of intermittent observations from one person is given by the transition probability <span class="math inline">\(p_{rs}(u)\)</span> between the corresponding pair of states <span class="math inline">\(r=X(t_{ij}), s=X(t_{ij+1})\)</span> over the time interval <span class="math inline">\(u=t_{ij+1}-t_{ij}\)</span>. The full likelihood is obtained by multiplying the likelihood contributions from each interval <span class="math inline">\(j\)</span> and person <span class="math inline">\(i\)</span>, and is maximsed using standard maximisation algorithms.</p>
<p>Given the estimates of transition rates, the package we will use for simulating from a multistate model is <code>hesim</code>, which allows to efficiently implement Markov models. The specification of survival models for each transition allows <code>hesim</code> to simulate transition or jump times between states. These are simulated from the probability density function for time-to-event <span class="math inline">\(t^\star\)</span> for the <span class="math inline">\(r\rightarrow s\)</span> transition <span class="math inline">\(f_{rs}(t^\star\mid\theta(s),t_j)\)</span>, where <span class="math inline">\(t^\star \geq 0\)</span> and parameters <span class="math inline">\(\theta=(\theta_1,\ldots,\theta_p)\)</span> may depend on the covariates <span class="math inline">\(z\)</span> through a link function <span class="math inline">\(g(\theta_p)=z^Z\gamma\)</span> with <span class="math inline">\(\gamma\)</span> being a vector of regression coefficients. The time <span class="math inline">\(t^\star\)</span> is the time-in-model if using a clock-forward model and time-in-state when using a clock-reset model. Given a system for simulating jump times, <code>hesim</code> uses an algorithm to generate transition times and manage competing risks:</p>
<ol type="1">
<li>Let <span class="math inline">\(r\)</span> be the state entered at time <span class="math inline">\(t_j\)</span> and let the number of allowed transitions from state <span class="math inline">\(r\)</span> be <span class="math inline">\(n_r\)</span>, where if <span class="math inline">\(j=0\)</span> then <span class="math inline">\(t_j=0\)</span>.</li>
<li>Simulate times <span class="math inline">\(T=t_{1,j+1},\ldots,t_{n_{r}j+1}\)</span> to each of the <span class="math inline">\(n_r\)</span> allowed transitions</li>
<li>Set the time of the transition <span class="math inline">\(t_{j+1}\)</span> equal to the minimum simulated time in <span class="math inline">\(T\)</span> and the next state <span class="math inline">\(s\)</span> to the state with the minimum simulated time.</li>
<li>Set <span class="math inline">\(r=s\)</span> and <span class="math inline">\(t_j=t_{j+1}\)</span>. If the individual is still alive, repeat the previous steps until death.</li>
</ol>
<p>Given the simulated diease progression <span class="math inline">\(D\)</span>, total costs and QALYs are simulated by summing the outcome values accumulated by each state <span class="math inline">\(h\)</span> and time <span class="math inline">\(t\)</span>, ie <span class="math inline">\(z_h(t)\)</span><span class="citation" data-cites="siebert2012state">(<a href="#ref-siebert2012state" role="doc-biblioref">Siebert et al. 2012</a>)</span>. In <code>hesim</code> times are partitioned into <span class="math inline">\(M\)</span> intervals over which these values are constant at <span class="math inline">\(z_{hm}\)</span> for each <span class="math inline">\(m\)</span>, where <span class="math inline">\(m\)</span> contains times <span class="math inline">\(t\)</span> such that <span class="math inline">\(t_m &lt; t \leq t_{m+1}\)</span>. Discounted outcome values for health state <span class="math inline">\(h\)</span> are given by</p>
<p><span class="math display">\[
\sum_{m+1}^M\int_{t_m}^{t_{m+1}}z_{hm}e^{-rt}dt=\sum_{m=1}^M z_{hm}\Biggl(\frac{e^{-rt_m}-e^{-rt_{m+1}}}{r}\Biggl),
\]</span> where <span class="math inline">\(r\geq 0\)</span> is the discount rate and, when <span class="math inline">\(r=0\)</span> this simplifies to <span class="math inline">\(\sum_{m=1}^Mz_{hm}(t_{m+1}-t_m)\)</span>. In a cohort model, state values generally depend only on time through time-in-model, and it is challenging to implement dependence on time-in-state. By contrast, is it straightforward for individual-level models to allow state values to depend on time-in-state.</p>
</section>
<section id="case-study" class="level2">
<h2 class="anchored" data-anchor-id="case-study">Case study</h2>
<p>The colon cancer data previously explored in cohort models is also considered here. The multistate model is formed by <span class="math inline">\(H=4\)</span> health states, so that the <span class="math inline">\(Q\)</span> matrix of transition rates is a <span class="math inline">\(4 \times 4\)</span> matrix, with the four allowed transition rates making up the off-diagonal elements of the matrix: 1) from Recurrence-free to Recurrence; 2) from Recurrence-free to Dead(all cause); 3) from Recurrence to Dead(cancer); 4) from Recurrence to Dead(all cause).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The model is <em>irreversible</em> as individuals cannot return to their previous states. Note that these transitions are different from those allowed over an interval of time. For example, over one year, an individual can transition from Recurrence-free to Dead(cancer), but in a continuous time model we assume this happened via a transition to recurrence at some point in the year. Each state will be associated with an annualised cost and utility value which will be used to estimate total outcome values. We still consider three alternative treatment options (None, A and AB), which are assumed to affect only the transition from Recurrence-free to Recurrence, and are associated with a cost and risk of toxicity, where toxicities have an impact on costs and QALYs.</p>
<p>Unlike in the cohort Markov model, where transitions between states were represented by probabilities, we will now be fitting survival models to the time-to-event data in the underlying data set. The data are stored in the file called <code>msm_colon.rda</code> which can be loaded in the <code>R</code> workspace using the <code>load()</code> function. The first few rows of the data set would then appear as</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  id      rx age sex from to  Tstart    Tstop    years status trans strategy_id
1  1 Lev+5FU  43   1    1  2 0.00000 2.650240 2.650240      1     1           3
2  1 Lev+5FU  43   1    1  3 0.00000 2.650240 2.650240      0     2           3
3  1 Lev+5FU  43   1    1  4 0.00000 2.650240 2.650240      0     3           3
4  1 Lev+5FU  43   1    2  3 2.65024 4.164271 1.514031      1     4           3
5  1 Lev+5FU  43   1    2  4 2.65024 4.164271 1.514031      0     5           3
6  2 Lev+5FU  63   1    1  2 0.00000 8.451745 8.451745      0     1           3</code></pre>
</div>
</div>
<p>We will assign names to the different allowed transitions to ease the interpretation of the code, thus we create an object to contain these names.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#give names to possible trans: Recurrence-free-Recurrence, Recurrence-free-Dead(all cause), Recurrence-Dead(cancer), Recurrence-Dead(all cause)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>trans_name <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RF-R"</span>,<span class="st">"RF-OCD"</span>,<span class="st">"R-CD"</span>,<span class="st">"R-OCD"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>There are <span class="math inline">\(3663\)</span> rows which include observed times of transition between states, and censored times of transitions to “competing risks”, ie transitions that a person was at risk of but that did not happen. For example, the first person in the data set transitioned from state <span class="math inline">\(1\)</span> (<code>from</code>) to state <span class="math inline">\(2\)</span> (<code>to</code>) at <span class="math inline">\(2.65\)</span> years (<code>Tstop</code>). This transition event implies a censoring time of <span class="math inline">\(2.65\)</span> for the competing transition from state <span class="math inline">\(1\)</span> to state <span class="math inline">\(3\)</span> and <span class="math inline">\(4\)</span> (<code>Tstart</code>).</p>
<p>The variable <code>id</code> is the individual identifier while <code>rx</code> uses the codes <span class="math inline">\(1\)</span>, <span class="math inline">\(2\)</span> and <span class="math inline">\(3\)</span> to denote the treatment option to which each individual is assigned, namely “None”, “A” and “AB”, respectively. The variables <code>age</code> and <code>sex</code> are the corresponding demographics, <code>from</code> and <code>to</code> are the starting and finishing state of each transition, <code>Tstart</code> is the time that the individual started in the <code>from</code> state, while <code>Tstop</code> is the time they exit that state to move to the <code>to</code> state. The variable <code>year</code> gives the time spent in state <code>from</code>, while <code>status</code> indicates if the transition was actually observed (<span class="math inline">\(1\)</span>) or censored (<span class="math inline">\(0\)</span>). For example, a transition from Recurrence-free to Recurrence would be censored if the individual moved to Dead(all cause) before they had a recurrence. The column <code>trans</code> specifies the transition number.</p>
</section>
<section id="estimating-multistate-models-with-fully-observed-data" class="level2">
<h2 class="anchored" data-anchor-id="estimating-multistate-models-with-fully-observed-data">Estimating multistate models with fully-observed data</h2>
<p>After structuring the data in the required format, we can fit the time-to-event models to inform our clock-reset <span class="math inline">\(4\)</span>-state model. We first load the necessary packages and set a random seed number.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#load required packages</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flexsurv)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">23456</span>) <span class="co">#set rng for reproducibility</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We choose a set of distributions to explore for each transition, considering only standard parametric models for this application. We will then choose the model with minimum AIC on the observed data for each transition, although the choice should be informed also based on their extrapolation and fit compared to long-term data, when these are available. To implement minimum AIC selection, we build a table to compare the performance of distributions for transitions in our clock-reset model. We use the <code>flexsurvreg()</code> and <code>Surv()</code> functions to fit these models to the data set. Treatments are only assumed to affect transitions from Recurrence-free to Recurrence, and assume no other covariate effects on transition rates. By default, the <code>Surv()</code> function fitted to the <code>Tstart</code> and <code>Tstop</code> columns would use time since entering the model as the time parameter of the survival models, and thus result in a clock-forward model. We will instead apply <code>Surv()</code> to <code>years</code> so as to use time spent in the current state as the time variable, and thus obtain a clock-reset model for each transition.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get distribution names available from flexsurv package</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>distr_name <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"exp"</span>, <span class="st">"weibull"</span>, <span class="st">"gompertz"</span>, <span class="st">"lognormal"</span>, <span class="st">"llogis"</span>, <span class="st">"gamma"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#matrix to store summaries of the clock-reset distributions</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>surv_aic <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">length</span>(distr_name),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ncol =</span> <span class="fu">length</span>(trans_name),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dimnames =</span> <span class="fu">list</span>(distr_name, trans_name))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">#list to store survival models to be used in multistate model</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>surv_model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">#list of distributions fit to time-in-state</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>surv_formula <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">#set transitions that depend on trt</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>surv_formula[[<span class="st">"RF-R"</span>]] <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"Surv(years, status) ~ factor(strategy_id)"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">#set transitions that are independent of trt</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>surv_formula[[<span class="st">"RF-OCD"</span>]] <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"Surv(years, status) ~ 1"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>surv_formula[[<span class="st">"R-CD"</span>]] <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"Surv(years, status) ~ 1"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>surv_formula[[<span class="st">"R-OCD"</span>]] <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"Surv(years, status) ~ 1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We loop over transitions and distributions fitting the models and extracting the AIC.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#fit different surv dist to each transition and extract AIC</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i_trans <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(trans_name)){ <span class="co">#loop over transitions </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  surv_model[[trans_name[[i_trans]]]] <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co">#list to contain model results</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_dist <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(distr_name)){ <span class="co">#loop over distributions </span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#fit distribution for each transition</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    surv_model[[i_trans]][[distr_name[[i_dist]]]] <span class="ot">&lt;-</span>  </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">flexsurvreg</span>(surv_formula[[i_trans]],  <span class="co">#choose survival formula</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">subset =</span> (trans <span class="sc">==</span> i_trans), <span class="co">#choose transition</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> msm_colon, <span class="at">dist =</span> distr_name[i_dist]) <span class="co">#give data and distr name</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#extract AIC value per model and transition </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    surv_aic[i_dist, i_trans] <span class="ot">&lt;-</span> </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      surv_model[[i_trans]][[distr_name[[i_dist]]]]<span class="sc">$</span>AIC</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For each transition we now choose the distribution with minimum AIC.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#object to store selected distribution based on minimum AIC</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>min_AIC <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="fu">length</span>(trans_name))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(min_AIC) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Distribution"</span>, <span class="st">"AIC"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(min_AIC) <span class="ot">&lt;-</span> trans_name</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#extract best distribution for each transition</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>min_AIC[<span class="st">"Distribution"</span>, ] <span class="ot">&lt;-</span> distr_name[<span class="fu">apply</span>(surv_aic, <span class="fu">c</span>(<span class="dv">2</span>), which.min)]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>min_AIC[<span class="st">"AIC"</span>, ] <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">apply</span>(surv_aic, <span class="fu">c</span>(<span class="dv">2</span>), min), <span class="at">digits =</span> <span class="dv">2</span>) </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#show results</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>min_AIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             RF-R       RF-OCD   R-CD       R-OCD   
Distribution "gompertz" "exp"    "gompertz" "llogis"
AIC          "2535.87"  "403.48" "3211.49"  "1202.3"</code></pre>
</div>
</div>
</section>
<section id="estimating-multistate-models-with-panel-data" class="level2">
<h2 class="anchored" data-anchor-id="estimating-multistate-models-with-panel-data">Estimating multistate models with panel data</h2>
<p>We now use the <code>msm</code> package to estimate constant transition rates with panel data. We first load the artificial panel version of the colon data (<code>panel_colon_data.rda</code>), consisting in a series of observations of the state occupancy for each individual <code>id</code> on <code>strategy_id</code> at time point <code>years</code>. The first few rows of the panel data set look like</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  id strategy_id age sex    years state
2  1           3  43   1 1.063052     1
3  1           3  43   1 2.183803     1
4  1           3  43   1 2.209600     1
5  1           3  43   1 2.487186     1
6  1           3  43   1 3.790750     2
7  1           3  43   1 3.818891     2</code></pre>
</div>
</div>
<p>We use the function <code>statetable.msm()</code> to summarise the number of observed transitions between states in successive observations: for example, we observe that there were <span class="math inline">\(383\)</span> transitions from Recurrence-free to Recurrence and <span class="math inline">\(2\)</span> transitions from Recurrence to Dead(all cause). Note that we do not know the times of all transitions in continuous time, as these are only available over some time interval.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#summary of transitions</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">statetable.msm</span>(<span class="at">state =</span> state, <span class="at">subject =</span> id, <span class="at">data =</span> panel_colon)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    to
from    1    2    3    4
   1 4023  383   41  466
   2    0 1211  367    2</code></pre>
</div>
</div>
<p>To fit a multistate model to these data, we need to specify the allowed transitions in continuous time. These are stored in a <span class="math inline">\(4\times 4\)</span> matrix which is passed to <code>msm</code>, with the entry in row <span class="math inline">\(r\)</span> and column <span class="math inline">\(s\)</span> equal to <span class="math inline">\(1\)</span> if an instantaneous transition in continuous time is allowed from state <span class="math inline">\(r\)</span> to state <span class="math inline">\(s\)</span>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#allowed transitions matrix</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>colon_qmatrix <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="co">#RF-R, RF-OCD</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="co">#R-OCD, R-CD</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="co">#OCD-none</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>) <span class="co">#CD-none</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#assign names</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(colon_qmatrix) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(colon_qmatrix) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Recurrence-free"</span>, <span class="st">"Recurrence"</span>, <span class="st">"Dead(cancer)"</span>, <span class="st">"Dead(all cause)"</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#estimate transition rates using msm</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">#take as inputs the state, time and id variables</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>colon_msm_fit <span class="ot">&lt;-</span> <span class="fu">msm</span>(state <span class="sc">~</span> years, <span class="at">subject =</span> id, <span class="at">data =</span> panel_colon,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#trt only affect RF-R transition as predictor</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">covariates =</span> <span class="fu">list</span>(<span class="st">"1-2"</span> <span class="ot">=</span> <span class="er">~</span> strategy_id), </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#assume time of entry in OCD and CD but alive before </span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">deathexact =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>),</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#matrix of allowed transitions</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">qmatrix =</span> colon_qmatrix,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#generate initial values for transition rates</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">gen.inits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#do not center predictors</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">center =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="co">#show results</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>colon_msm_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
msm(formula = state ~ years, subject = id, data = panel_colon,     qmatrix = colon_qmatrix, gen.inits = TRUE, covariates = list(`1-2` = ~strategy_id),     deathexact = c(3, 4), center = FALSE)

Maximum likelihood estimates
Baselines are with covariates set to 0

Transition intensities with hazard ratios for each covariate
                                  Baseline                      
Recurrence-free - Recurrence-free -0.094329 (-0.103690,-0.08581)
Recurrence-free - Recurrence       0.050239 ( 0.042752, 0.05904)
Recurrence-free - Dead(all cause)  0.044090 ( 0.040085, 0.04850)
Recurrence - Recurrence           -0.385315 (-0.424537,-0.34972)
Recurrence - Dead(cancer)          0.375742 ( 0.340013, 0.41523)
Recurrence - Dead(all cause)       0.009573 ( 0.002458, 0.03728)
                                  strategy_id2         strategy_id3         
Recurrence-free - Recurrence-free                                           
Recurrence-free - Recurrence      1.034 (0.8272,1.292) 0.5519 (0.433,0.7036)
Recurrence-free - Dead(all cause) 1.000                1.0000               
Recurrence - Recurrence                                                     
Recurrence - Dead(cancer)         1.000                1.0000               
Recurrence - Dead(all cause)      1.000                1.0000               

-2 * log-likelihood:  9515.441 </code></pre>
</div>
</div>
<p>Once the transition rates and covariate effects are estimated, we can convert these to transition probabilities using the <code>pmatrix.msm</code> function. For models with covariates, we also need to specify for which covariate categories to estimate the transition probabilities. As an example, here we estimate these for the first treatment</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#convert transition rate into probs for trt=1</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pmatrix.msm</span>(colon_msm_fit, <span class="at">covariates =</span> <span class="fu">list</span>(<span class="at">strategy_id =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                Recurrence-free Recurrence Dead(cancer) Dead(all cause)
Recurrence-free       0.9099833 0.03966592   0.00807061     0.042280140
Recurrence            0.0000000 0.68023659   0.31181935     0.007944065
Dead(cancer)          0.0000000 0.00000000   1.00000000     0.000000000
Dead(all cause)       0.0000000 0.00000000   0.00000000     1.000000000</code></pre>
</div>
</div>
</section>
<section id="cost-effectiveness-modelling-in-multistate-models" class="level2">
<h2 class="anchored" data-anchor-id="cost-effectiveness-modelling-in-multistate-models">Cost-effectiveness modelling in multistate models</h2>
<p>We will use the <code>hesim</code> package to implement individual-level continuous-time clock-reset multistate models to the colon cancer data, considering fully-observed data for simplicity. We consider <em>probabilistic analyses</em>, where uncertainty in the input parameters is propagated to the estimated costs and benefits, which is a compulsory requirement when reporting CE results from model-based analyses for many HTA authorities<span class="citation" data-cites="national2022nice nederland2024guideline">(<a href="#ref-national2022nice" role="doc-biblioref">Health and Excellence 2022</a>; <a href="#ref-nederland2024guideline" role="doc-biblioref">Nederland 2024</a>)</span>.</p>
<p>We first load the necessary packages, including <code>data.table</code>, <code>flexsurv</code>, <code>hesim</code>, <code>ggplot2</code> and <code>BCEA</code>, and specify the variables that define the model and analyse the results.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flexsurv)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hesim)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BCEA)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">#define variables</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>state_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Recurrence-free"</span>, <span class="st">"Recurrence"</span>,  </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Dead(cancer)"</span>, <span class="st">"Dead(all cause)"</span>) <span class="co">#names of states</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>trt_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"None"</span>, <span class="st">"A"</span>, <span class="st">"AB"</span>) <span class="co">#trt names</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>n_patients <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co">#n simulated individuals </span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="dv">200</span> <span class="co">#n samples</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>n_state <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co">#n states</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>n_trt <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co">#n trt</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The allowed transitions need to be assigned a unique consecutive number in the <code>transition_matrix</code> that links them to the relevant states, with not allowed transitions being assigned an <code>NA</code> value.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#build trans matrix</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>trans_matrix <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="dv">2</span>), <span class="co">#RF-R, RF-OCD</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="dv">3</span>, <span class="dv">4</span>), <span class="co">#R-OCD, R-CD</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>), <span class="co">#OCD-none</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>) <span class="co">#CD-none</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">#assign names</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(trans_matrix) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(trans_matrix) <span class="ot">&lt;-</span> state_names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The treatments are also given unique consecutive numbers in the <code>strategies</code> data table below, with also the patients to be sampled that will be included in a data table with consecutive numeric <code>patient_id</code> and associated baseline characteristics.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#trt to compare</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">strategy_id =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">strategy_name =</span> trt_names</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#individuals are randomly sampled with replacement from the colon data set</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#sample patient id to preserve correlation between age and sex</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>patient_id_sample <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_patients, <span class="at">size =</span> n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="co">#sample patients with replacement and put sampled data into a data table object</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">patient_id =</span> <span class="dv">1</span><span class="sc">:</span>n_patients,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> msm_colon<span class="sc">$</span>age[patient_id_sample],</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">sex =</span> msm_colon<span class="sc">$</span>sex[patient_id_sample]</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">#need to specify non-death states</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">state_id =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>),</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">state_name =</span> <span class="fu">rownames</span>(trans_matrix)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>hesim_data()</code> function can be used to create lists of treatments, patients, and states for simulation, while <code>expand()</code> duplicates patients for each treatment, and the <code>get_labels()</code> function allows to create labels for the treatments, subgroups, states and transitions.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#data specification for hesim package</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>hesim_data <span class="ot">&lt;-</span> <span class="fu">hesim_data</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">strategies =</span> strategies,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">patients =</span> patients,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">states =</span> states</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">#duplicate individuals for each treatment</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>trans_model_data <span class="ot">&lt;-</span> <span class="fu">expand</span>(hesim_data, </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"strategies"</span>, <span class="st">"patients"</span>))</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">#generate model labels</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>hesim_labels <span class="ot">&lt;-</span> <span class="fu">get_labels</span>(hesim_data)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>hesim_labels<span class="sc">$</span>transition_id <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RF-R"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RF-OCD"</span> <span class="ot">=</span> <span class="dv">2</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"R-CD"</span> <span class="ot">=</span> <span class="dv">3</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"R-OCD"</span> <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">#assign numbers to names</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>hesim_labels<span class="sc">$</span>state_id <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>n_state)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(hesim_labels<span class="sc">$</span>state_id) <span class="ot">&lt;-</span> state_names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The disease simulation is constructed using individual-level continuous-time survival models on each of the transitions using the chosen distributions before by providing the required inputs to the <code>create_IndivCtstmTrans()</code> function</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract into a list the chosen survival models for each transition</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>hesim_surv <span class="ot">&lt;-</span> <span class="fu">flexsurvreg_list</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  surv_model[[<span class="st">"RF-R"</span>]][[<span class="st">"gompertz"</span>]],</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  surv_model[[<span class="st">"RF-OCD"</span>]][[<span class="st">"gompertz"</span>]],</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  surv_model[[<span class="st">"R-CD"</span>]][[<span class="st">"llogis"</span>]],</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  surv_model[[<span class="st">"R-OCD"</span>]][[<span class="st">"exp"</span>]]</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">#fit model to transition data</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>trans_model <span class="ot">&lt;-</span> <span class="fu">create_IndivCtstmTrans</span>(</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> hesim_surv, <span class="co">#list of surv models</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">input_data =</span> trans_model_data, <span class="co">#transition models</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">trans_mat =</span> trans_matrix, <span class="co">#trans matrix</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> S, <span class="co">#n samples</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">clock =</span> <span class="st">"reset"</span>, <span class="co">#clock-reset version</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_age =</span> patients<span class="sc">$</span>age <span class="co">#starting age for each patient</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The utility and cost models are specified as unique values for all combinations of treatment, state, individual, sample and time. In the colon cancer case, utilities are a combination of state utility and disutility due to toxicity, both randomly sampled. There are two time period: in the first year individuals have a risk of toxicity and associated disutility, and thereafter they only experience state utility. We need unique values for each state, sample, treatment and for each of the two time periods. The following code is used to create this custom table.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#time periods for utility</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>n_u_time <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#sample utilities and probs separately and combine into a utility table, where number of states is the number of states minus number of absorbing states</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>u_table <span class="ot">&lt;-</span> <span class="fu">stateval_tbl</span>(</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">strategy_id =</span> <span class="fu">rep</span>( <span class="co">#values for each trt</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>n_trt), <span class="at">each =</span> <span class="fu">length</span>(states<span class="sc">$</span>state_id) <span class="sc">*</span> n_u_time <span class="sc">*</span> S</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample =</span> <span class="fu">rep</span>( <span class="co">#values for each sample</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>S), <span class="at">each =</span> <span class="fu">length</span>(states<span class="sc">$</span>state_id) <span class="sc">*</span> n_u_time),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> n_trt <span class="co">#repeated for each trt</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">state_id =</span> <span class="fu">rep</span>( <span class="co">#values for each state</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(states<span class="sc">$</span>state_id), <span class="at">each =</span> n_u_time),</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> n_trt <span class="sc">*</span> S <span class="co">#repeated for each trt and sample</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_start =</span> <span class="fu">rep</span>( <span class="co">#values for each time point</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> n_trt <span class="sc">*</span> S <span class="sc">*</span> <span class="fu">length</span>(states<span class="sc">$</span>state_id) <span class="co">#repeated for each trt, sample and state</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="dv">1</span>),</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist =</span> <span class="st">"custom"</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(u_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   sample strategy_id state_id time_id time_start time_stop value
    &lt;int&gt;       &lt;int&gt;    &lt;int&gt;   &lt;int&gt;      &lt;num&gt;     &lt;num&gt; &lt;num&gt;
1:      1           1        1       1          0         1     1
2:      1           1        1       2          1       Inf     1
3:      1           1        2       1          0         1     1
4:      1           1        2       2          1       Inf     1
5:      2           1        1       1          0         1     1
6:      2           1        1       2          1       Inf     1</code></pre>
</div>
</div>
<p>Uncertainty about state utilities expressed using Normal distributions, as for probabilities and disutilities of toxicity for each treatment.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Normal distributions to sample utilities for each state</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>u_RF <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(S, <span class="at">mean =</span> <span class="fl">0.8</span>, <span class="at">sd =</span> <span class="fl">0.1</span><span class="sc">*</span><span class="fl">0.8</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>u_R <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(S, <span class="at">mean =</span> <span class="fl">0.6</span>, <span class="at">sd =</span> <span class="fl">0.1</span><span class="sc">*</span><span class="fl">0.6</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Normal distributions to sample probs of toxicity for each trt</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>p_tox_A <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(S, <span class="at">mean =</span> <span class="fl">0.2</span>, <span class="at">sd =</span> <span class="fl">0.1</span><span class="sc">*</span><span class="fl">0.2</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>p_tox_AB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(S, <span class="at">mean =</span> <span class="fl">0.4</span>, <span class="at">sd =</span> <span class="fl">0.1</span><span class="sc">*</span><span class="fl">0.4</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Normal distributions to sample disutilities </span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>disu_tox <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(S, <span class="at">mean =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">sd =</span> <span class="fl">0.1</span><span class="sc">*</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can now calculate the combined utilities</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#fill in utility table values for each trt, state and period</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>u_table[strategy_id <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> state_id <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"value"</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  u_RF, u_RF</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>u_table[strategy_id <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> state_id <span class="sc">==</span> <span class="dv">2</span>, <span class="st">"value"</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  u_R, u_R</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>u_table[strategy_id <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> state_id <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"value"</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  u_RF <span class="sc">+</span> p_tox_A <span class="sc">*</span> disu_tox, u_RF</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>u_table[strategy_id <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> state_id <span class="sc">==</span> <span class="dv">2</span>, <span class="st">"value"</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  u_R <span class="sc">+</span> p_tox_A <span class="sc">*</span> disu_tox, u_R</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>u_table[strategy_id <span class="sc">==</span> <span class="dv">3</span> <span class="sc">&amp;</span> state_id <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"value"</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  u_RF <span class="sc">+</span> p_tox_AB <span class="sc">*</span> disu_tox, u_RF</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>u_table[strategy_id <span class="sc">==</span> <span class="dv">3</span> <span class="sc">&amp;</span> state_id <span class="sc">==</span> <span class="dv">2</span>, <span class="st">"value"</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  u_R <span class="sc">+</span> p_tox_AB <span class="sc">*</span> disu_tox, u_R</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The filled-in table values can then be now passed to the function <code>create_StateVals()</code> to generate the utility model to be used in the successive economic analysis.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create utility model</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>u_model <span class="ot">&lt;-</span> <span class="fu">create_StateVals</span>(u_table,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">hesim_data =</span> hesim_data,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The cost models are specified in a similar way to the utilities, except that there are now two models. One is for treatment costs and the other is for state costs. In our case, treatment costs are applied once at the start of the model and there is a unique value for each treatment and sample. State costs are assumed zero except for a one-off cost of <span class="math inline">\(40,000\)</span> for advanced treatment in the Reecurrence state.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#trt costs depend on costs of adverse events - one off</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>trt_cost_table <span class="ot">&lt;-</span> <span class="fu">stateval_tbl</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">strategy_id =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>n_trt), <span class="at">each =</span> S),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>S), <span class="at">times =</span> n_trt),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="dv">1</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist =</span> <span class="st">"custom"</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">#state costs 0 except one-off cost of advanced trt</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>n_cost_times <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co">#only for Recurrence state</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>state_cost_table <span class="ot">&lt;-</span> <span class="fu">stateval_tbl</span>(</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">state_id =</span> <span class="fu">rep</span>(states<span class="sc">$</span>state_id, <span class="at">each =</span> n_cost_times),</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_start =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">times =</span> <span class="fu">length</span>(states<span class="sc">$</span>state_id)),</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">est =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">40000</span>, <span class="dv">0</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist =</span> <span class="st">"fixed"</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="co">#simulate distributions for toxicity cost and combine it with trt costs and probs of toxicity to get trt costs</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="co">#Normal distributions to sample tox costs</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>c_tox <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(S, <span class="at">mean =</span> <span class="dv">2000</span>, <span class="at">sd =</span> <span class="fl">0.1</span><span class="sc">*</span><span class="dv">2000</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>trt_cost_table[strategy_id <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"value"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>trt_cost_table[strategy_id <span class="sc">==</span> <span class="dv">2</span>, <span class="st">"value"</span>] <span class="ot">&lt;-</span> <span class="dv">5000</span> <span class="sc">+</span> p_tox_A <span class="sc">+</span> cost_tox</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>trt_cost_table[strategy_id <span class="sc">==</span> <span class="dv">3</span>, <span class="st">"value"</span>] <span class="ot">&lt;-</span> <span class="dv">10000</span> <span class="sc">+</span> p_tox_AB <span class="sc">+</span> cost_tox</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, we pass the two cost tables to the function <code>create_StateVals()</code> to create treatment and state cost models.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#trt costs depend on costs of adverse events - one off</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>trt_c_model <span class="ot">&lt;-</span> <span class="fu">create_StateVals</span>(trt_cost_table,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">hesim_data =</span> hesim_data,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> S)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>state_c_model <span class="ot">&lt;-</span> <span class="fu">create_StateVals</span>(state_cost_table,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">hesim_data =</span> hesim_data,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> S)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">#combined costs model</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>c_model <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Drug =</span> trt_c_model, <span class="co">#drug=trt</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">Medical =</span> state_c_model) <span class="co">#medical=state</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Simulation of the disease progression, costs and utilities is done using the function <code>IndivCtstm$new()</code> as follows</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#build combined CE model of progression, cost and utility</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>HE_model <span class="ot">&lt;-</span> IndivCtstm<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trans_model =</span> trans_model,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">utility_model =</span> u_model,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cost_models =</span> c_model</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Simulation is conducted using the <code>sim_disease()</code>, which simulates disease and creates the object <code>disprog_</code> in the form of a data table, whose columns store the transitions from a state entered at <code>time_start</code> to another state at <code>time_stop</code>, for each sample, treatment and patient.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#disease modelling</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>HE_model<span class="sc">$</span><span class="fu">sim_disease</span>()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#show first few rows from table results</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(HE_model<span class="sc">$</span>disprog_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   sample strategy_id patient_id grp_id  from    to final time_start time_stop
    &lt;num&gt;       &lt;int&gt;      &lt;int&gt;  &lt;int&gt; &lt;num&gt; &lt;num&gt; &lt;int&gt;      &lt;num&gt;     &lt;num&gt;
1:      1           1          1      1     1     2     0  0.0000000 0.8144538
2:      1           1          1      1     2     4     1  0.8144538 0.9323860
3:      1           1          2      1     1     2     0  0.0000000 1.7236627
4:      1           1          2      1     2     4     1  1.7236627 2.0494535
5:      1           1          3      1     1     2     0  0.0000000 0.3812736
6:      1           1          3      1     2     4     1  0.3812736 1.4180792</code></pre>
</div>
</div>
<p>After disease progression has been simulated, then also discounted costs and QALYs can be simulated using the dedicated functions <code>sim_costs()</code> and <code>sim_qalys()</code></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#costs and QALYs modelling (with discount factor)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>HE_model<span class="sc">$</span><span class="fu">sim_costs</span>(<span class="at">dr =</span> <span class="fl">0.03</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>HE_model<span class="sc">$</span><span class="fu">sim_qalys</span>(<span class="at">dr =</span> <span class="fl">0.015</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>State occupancy probabilities can be calculated using the function <code>sim_stateprobs()</code>, taking as input a vector of time points <span class="math inline">\(t\)</span> at which the probabilities should be estimated</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SOPs for clock-reset model</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>HE_model<span class="sc">$</span><span class="fu">sim_stateprobs</span>(<span class="at">t =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">20</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>)) <span class="co">#at 241 times</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>and which are stored in the object <code>state_probs_</code>. We can use the function <code>autoplot()</code> to plot the state occupancy probabilities estimated before, averaged by treatments, states and times.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#combine SOPs by trt, state and time</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>state_probs <span class="ot">&lt;-</span> HE_model<span class="sc">$</span>stateprobs_[, .(<span class="at">prob_mean =</span> <span class="fu">mean</span>(prob)), </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"strategy_id"</span>, <span class="st">"state_id"</span>, <span class="st">"t"</span>)]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">#plot SOPs</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(HE_model<span class="sc">$</span>stateprobs_, <span class="at">labels =</span> hesim_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="code3_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can finally analyse the CE results using functions from the <code>BCEA</code> package. First we need to convert the <code>hesim</code> output into a form that is accepated by <code>BCEA</code>, namely summarised in terms of average total costs and QALYs per treatment arm across all times and states.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#convert output into BCEA accepted format</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>hesim_sum <span class="ot">&lt;-</span> HE_model<span class="sc">$</span><span class="fu">summarize</span>()</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">#create empty matrices of dimensions S x 3 to store total costs and QALYs</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>costs_mat <span class="ot">&lt;-</span> effects_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> S, <span class="at">ncol =</span> n_trt, </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="cn">NULL</span>, trt_names))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">#loop over trt to aggregate outcome values</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i_trt <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_trt){</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  costs_mat[, i_trt] <span class="ot">&lt;-</span> <span class="fu">with</span>(</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    hesim_sum<span class="sc">$</span>costs,</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    costs[category <span class="sc">==</span> <span class="st">"total"</span> <span class="sc">&amp;</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>      strategy_id <span class="sc">==</span> i_trt <span class="sc">&amp;</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>      dr <span class="sc">==</span> <span class="fl">0.03</span>]</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  effects_mat[, i_trt] <span class="ot">&lt;-</span> <span class="fu">with</span>(</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    hesim_sum<span class="sc">$</span>qalys,</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    qalys[strategy_id <span class="sc">==</span> i_trt <span class="sc">&amp;</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>      dr <span class="sc">==</span> <span class="fl">0.015</span>]</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, we can use <code>BCEA</code> functions to produce standard CE output based on the economic results of the model. First, we use the <code>bcea()</code> function to automatically generate all the necessary output and store it in the object <code>colon_bcea</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#generate and return BCEA object (set ref=1 for comparator arm)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>colon_bcea <span class="ot">&lt;-</span> <span class="fu">bcea</span>(<span class="at">eff =</span> effects_mat, <span class="at">cost =</span> costs_mat, <span class="at">ref =</span> <span class="dv">1</span>, </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">interventions =</span> trt_names, <span class="at">Kmax =</span> <span class="dv">100000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, we can summarise the CE results using dedicated functions and plots. A general overview of the incremental results in terms of several CEA quantities (eg ICER) can be obtained via the function <code>summary()</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#print summary incrmental results assuming ref as comparator</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(colon_bcea)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Cost-effectiveness analysis summary 

Reference intervention:  None
Comparator intervention(s): A
                          : AB

Optimal decision: choose None for k &lt; 59400 and AB for k &gt;= 59400


Analysis for willingness to pay parameter k = 25000

     Expected net benefit
None               198681
A                  135761
AB                 121874

             EIB CEAC     ICER
None vs A  62920    1 -1542055
None vs AB 76807    1    59242

Optimal intervention (max expected net benefit) for k = 25000: None
                
EVPI -1.3786e-12</code></pre>
</div>
</div>
<p>We can also obtain standard CE graphs, such as the CE plane and CEAC using dedicated functions, as shown below.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#scatter plot of delta_e and delta_c with assumed value k for wtp</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">#points in shaded area  / total points = prob of cost-effectiveness at k</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ceplane.plot</span>(colon_bcea, <span class="at">wtp =</span> <span class="dv">100000</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">#prob of cost-effectiveness for a range of wtp values</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ceac.plot</span>(colon_bcea)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mm1-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mm1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="code3_files/figure-html/fig-mm1-1.png" id="fig-mm1-1" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-mm1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-mm1-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mm1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="code3_files/figure-html/fig-mm1-2.png" id="fig-mm1-2" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-mm1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>The code for <span class="math inline">\(4\)</span>-state clock-reset and forward models could be adapted to other clinical settings, although the presented strategies only included as baseline variables age and sex which were assumed to not affect the transition rate models. This could be modified to allow to better model individual heterogeneity by including these variables as covariates into the survival models and then passing the results of these models to <code>hesim</code>.</p>
<p>When data from a study are not available, indirect treatment comparison methods using multiple studies might be required, such as NMA. <code>hesim</code> can use estimated log hazard ratios from a proportional hazards NMA and the coefficients from non-proportional hazards NMA. Instead of passing <code>flexsurvref_list</code> objects to <code>create_IndivCtstmTrans()</code> it is possible to instead pass <code>params_surv_list</code> or <code>param_surv</code> objects for each possible transition, which take as arguments the type of distribution (<code>dist</code>) and samples of the coefficients (<code>coef</code>).</p>
<p>Partitioned survival models <span class="citation" data-cites="woods2017nice">(<a href="#ref-woods2017nice" role="doc-biblioref">Woods et al. 2017</a>)</span> provide alternative approaches to use when <em>Overall Survival</em> (OS) and <em>Progression-Free Survival</em> (PFS) <em>Kaplan-Meier</em> (KM) curves are available, while full individual history can be used through the use of Discrete Event Simulation models.</p>
</section>
</section>
<section id="sec-des" class="level1">
<h1>Discrete Event Simulation</h1>
<section id="introduction-1" class="level2">
<h2 class="anchored" data-anchor-id="introduction-1">Introduction</h2>
<p><em>Discrete Event Simulation</em> (DES) is a form of modelling for the occurrence of discrete events and the leaps in time between them<span class="citation" data-cites="karnon2014use">(<a href="#ref-karnon2014use" role="doc-biblioref">Karnon and Haji Ali Afzali 2014</a>)</span>. In contrast to cohort discrete-time state transition models, DESs allow modelling of individual-level trajectories and facilitate the incorporation of detailed clinical data to model complex clinical care pathways.</p>
<p>In general, DES is the modelling of a system as it changes with time by representing the instantaneous occurrences of events at separate time points, and may be applied either with or without <em>resource constraints</em>. Those with constraints might include scarce clinician availability on a hospital ward and typically involve the simulation of patient queuing systems, such as the optimisation of surgical devices and intensive care unit care capacity. Those without constraints might correspond to analyses where the overall resource scarcity is proxied by a CE threshold, and have been applied in areas such as smoking cessation interventions, cancer therapy and treatment for schizophrenia.</p>
<p>A few key elements can be identified which characterise DES<span class="citation" data-cites="karnon2014use">(<a href="#ref-karnon2014use" role="doc-biblioref">Karnon and Haji Ali Afzali 2014</a>)</span>: entities, attributes, events, timing. In particular, DES is an individual-level simulation approach where individual <em>entities</em> are modelled, while also simulating the time between a series of <em>events</em> for each simulated entity. These events might be sequential or related, and their ordering may be considered stochastic, ie sampled from joint distributions. Events may also be repeating or competing, depending on whether they may re-occur or prevent the occurrence of other events, ie death from one event competes with another event related to a different cause of death. The <em>timing</em> of events is often simulated as a stochastic process, while the timing of other processes, such as monthly transfusions, may be deterministic. The simulation of stochastic events is implemented through drawing from probability distributions for the given time-to-event using pseudorandom number generators, while the timing of events may be correlated with other distributions in the model to simulate associations between the probabilities of different events or their consequences in terms of benefits and costs. These distributions may vary between individuals according to <em>attributes</em> of simulated entities, which may be known at the outset of the simulation (eg age and sex) or may be determined within the model (eg treatment success of failure).</p>
<p>As a microsimulation approach, DES allows retaining information on attributes of each entity and aviods problems resulting from memory-less property of cohort state transition models, and is particularly suited for the simulation of time-varying event rates, including those based on non-constant hazard rates<span class="citation" data-cites="karnon2014use">(<a href="#ref-karnon2014use" role="doc-biblioref">Karnon and Haji Ali Afzali 2014</a>)</span>. DES allows to naturally record previous health events for simulated individuals, so that rates that vary with prior disease history can be easily implemented, and to incorporate heterogeneous patient populations and their subsequent simulation. DESs do not require assignment of individuals to mutually-exclusive states and they handle time in a continuous way, thus avoiding problems related to discrete-time approximations or multiple events occurring within a single discrete-time interval. However, DESs are typically more time-consuming than conventional cohort-based discrete time approaches.</p>
<p>In the following, we will use the term “individual” to denote simulated hypothetical individuals, and the term “resource” to denote, for example, operating rooms, medical supplies or healthcare professionals. To ease presentation of DES, we will not consider resources and their use, given that in standard HTA analyses constraints are not included explicitly. While in theory, individuals in DES can interact with each other, in practice few models implement these interactions. When this is considered an important feature for simulating the disease progression (eg infectious diseases), alternative approaches known as <em>Agent-based models</em> may be used instead <span class="citation" data-cites="hunter2021using">(<a href="#ref-hunter2021using" role="doc-biblioref">Hunter and Kelleher 2021</a>)</span>. These allow specification of the behaviour of agents, including individuals, which can drive the interactions and their outcomes, where interactions are assumed to occur at discrete times.</p>
</section>
<section id="implementation-in-r" class="level2">
<h2 class="anchored" data-anchor-id="implementation-in-r">Implementation in <code>R</code></h2>
<p>We illustrate the application of DES models in <code>R</code> through a case study on the CE of adjuvant therapy in colorectal cancer based on the <code>colon</code> data set available from the <code>survival</code> package, whose key characteristics have already been introduced in previous sections<span class="citation" data-cites="moertel1990levamisole">(<a href="#ref-moertel1990levamisole" role="doc-biblioref">Moertel et al. 1990</a>)</span>. In our application, we will perform a DES based cost-utility analysis modelling individuals through cycles of treatment and multiple recurrent events until death due to cancer or other causes.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Events such as recurrence and death were assumed to occur in continuous time, while chemotherapy treatment was assumed to occur on discrete treatment cycles.</p>
<p>Time to event for the modelled events is estimated using as input the <code>colon</code> data set and applying a series of parametric survival models, while estimates for clinical input parameters (eg probability of toxicities, costs and utilities) are assigned hypothetical values. Adjuvant treatments (A and AB) are assumed for a maximum of <span class="math inline">\(10\)</span> cycles and last for <span class="math inline">\(3\)</span> weeks; toxicities may occur during a treatment cycle with a given probability that is treatment-specific, with a maximum of <span class="math inline">\(1\)</span> toxicity event that a patient can experience per treatment. Utility during therapy and recurrence does not differ between treatments as well as the disutility due to toxicity, which is applied to the complete cycle in which a patient experiences a toxicity. QALYs are obtained by discounting and integrating utility over the duration of the cycle, while individuals experiencing a recurrence incur in a one-time cost assumed to be independent of treatment.</p>
<p>DESs may be implemented in <code>R</code> in different ways. In our example, we will use the package <code>simmer</code>, which implements a process-based approach, which requires the definition of two objects: the <em>trajectory</em> and the <em>simulation environment</em>.</p>
<p>The trajectory defines the structure of the model, consisting in what events the simulated individuals may experience and what actions are performed. They are defined using the <code>trajectory()</code> function, which defines an empty trajectory that can be expanded using different building blocks:</p>
<ul>
<li><p><em>Attributes</em> store numerical information on an individual or global level, such as characteristics (eg disease stage), outcomes (eg accrued QALYs and costs), and individualised model parameters (eg sampled time-to-events or risk predictions).</p></li>
<li><p><em>Timeouts</em> control the duration of time between different events or actions.</p></li>
<li><p><em>Resources</em> refer to shared objects between agents which may have limited capacity, such as the number of nurses in a department, number of operating rooms, number of times a given device can be used on a given day.</p></li>
<li><p><em>Branches</em> allocate individuals to different sub-trajectories and can be used to implement competing risks (eg continuing to next treatment cycle or stopping treatment).</p></li>
<li><p><em>Rollbacks</em> move an individual a number of steps back in the trajectory and can be used to repeat sections of the trajectory, useful for modelling repetitive activities such as treatment cycles.</p></li>
</ul>
<p>The simulation environment defines how many individuals enter the trajectory and when they enter, as well as what information should be gathered about the individuals and the resources throughout the simulation. It can be defined using the <code>simmer()</code> function, which can be expanded using different building blocks:</p>
<ul>
<li><p><em>Generators</em> define the cohort of agents that will be simulated.</p></li>
<li><p><em>Resources</em> define the amount and schedule of a type of resource to be available in the simulation.</p></li>
<li><p><em>Simulations</em> can be performed using the <code>run()</code> function.</p></li>
<li><p><em>Outcomes</em> are saved in the simulation environment and can be extracted using dedicated functions which return long-formatted data sets with complete logs of how values have changed throughout the simulation.</p></li>
</ul>
<p>We illustrate how the <code>simmer</code> package may be used to implement DES to the colon cancer example using different code snippets of different parts of the trajectory as the complete trajectory is too large to consider here. This means that these snippets cannot be run independently. The full code is available in the online appendix of the book: <a href="https://gianluca.statistica.it/books/online/r-hta">https://gianluca.statistica.it/books/online/r-hta</a>.</p>
<section id="initialisation" class="level3">
<h3 class="anchored" data-anchor-id="initialisation">Initialisation</h3>
<p>The first step is to define the main trajectory and initialise a set of individual-level attributes to track the treatment group, the time of death from background mortality and the time to recurrence, the number of adjuvant cycles received, the number of toxicities, the discounted costs and QALYs. The values are set using the <code>fn_initialisation()</code> function.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(simmer) <span class="co">#load package</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#define main trajectory object</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>traj_main <span class="ot">&lt;-</span> <span class="fu">trajectory</span>(<span class="at">name =</span> <span class="st">"traj_main"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#initialisation</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">#record individual-level attributes</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_attribute</span>(<span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"TreatmentArm"</span>, <span class="st">"BS"</span>, </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RFS"</span>, <span class="st">"AdjuvantCycles"</span>, <span class="st">"Toxicities"</span>, <span class="st">"dCosts"</span>, <span class="st">"dQALYs"</span>),</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="cf">function</span>() <span class="fu">fn_initialisation</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="ajuvant-treatment" class="level3">
<h3 class="anchored" data-anchor-id="ajuvant-treatment">Ajuvant treatment</h3>
<p>To implement adjuvant treatment cycles, a branch is used to determine whether individuals will receive any adjuvant treatment based on the arm. Within the adjuvant treatment sub-trajectory, the first step is to determine what event will happen in the treatment cycle and what the duration of the cycle will be using the custom <code>fn_adjuvant_cycles()</code> function: 1) <em>death</em>, due to the background mortality information stored for each individual in the <code>BS</code> attribute; 2) <em>Recurrence</em>, due to its time-to-recurrence information stored in the <code>RFS</code> attribute, after which the cycle will ended and the individual treated for the recurrence; 3) <em>Complete cycle</em>, due to no experiencing neither of the above events, so that the treatment cycle is ended and a next cycle can be started if the maximum number of cycles has not been reached.</p>
<p>After determining the event and time-to-event for the treatment cycle, the health and economic impact of the cycle is determined, and the individual is delayed for the duration of the cycle using the <code>timeout_from_attribute()</code> function. After processing the treatment cycle, a sequence of branches is used to determine what will happen next based on the <code>AdjuvantCycleEvent</code> attribute. If the individual deceased during the cycle, they will be directed to the final <code>traj_death</code> trajectory. If the individual is alive, the next branch checks whether a recurrence occurred, in which case they are directed to the <code>traj_recurrence</code> trajectory. Otherwise, a <code>rollback()</code> function is used to return the individual back to the beginning of the adjuvant treatment branch, if the maximum number of cycles has not been reached.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Adjuvant treatment</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">#determine if individuals receive trt, if trt =1 or 2 they enter the branch, otherwise they skip the branch</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">branch</span>(</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">option =</span> <span class="cf">function</span>()</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">keys =</span> <span class="st">"TreatmentArm"</span>) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">continue =</span> <span class="cn">TRUE</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#traj to determine what happens in branch</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trajectory</span>()</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="sc">%&gt;%</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#record event and duration of cycle</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_attribute</span>(</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"AdjuvantCycleEvent"</span>, <span class="st">"AdjuvantCycleTime"</span>),</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="cf">function</span>()</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fn_adjuvant_cycle</span>(</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">attrs =</span> <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim, </span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>                              <span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"BS"</span>, <span class="st">"RFS"</span>)),</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">t_now =</span> <span class="fu">now</span>(<span class="at">.env =</span> sim)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">#update number of cycles, toxicities, costs and QALYs</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_attribute</span>(</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"AdjuvantCycles"</span>, <span class="st">"Toxicities"</span>, <span class="st">"dCosts"</span>, <span class="st">"dQALYs"</span>),</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="cf">function</span>()</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fn_adjuvant_impact</span>(</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">attrs =</span> <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim,</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>                              <span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"TreatmentArm"</span>, <span class="st">"AdjuvantCycleTime"</span>)),</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">t_now =</span> <span class="fu">now</span>(<span class="at">.env =</span> sim)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">mod =</span> <span class="st">"+"</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#delay for duration of that cycle</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>   <span class="fu">timeout_from_attribute</span>(<span class="at">key =</span> <span class="st">"AdjuvantCycleTime"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">#check what will happen next based on AdjuvantCycleEvent</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#1=death, 2=recurrence, 3=no recurrence or death</span></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>   <span class="co">#check if individual is alive</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>   <span class="fu">branch</span>(</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>     <span class="at">option =</span> <span class="cf">function</span>() {</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>       <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim, </span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>                     <span class="at">keys =</span> <span class="st">"AdjuvantCycleEvent"</span>) <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>       },</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>     <span class="at">continue =</span> <span class="cn">FALSE</span>,</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>     traj_death</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>   ) <span class="sc">%&gt;%</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>   <span class="co">#check is individual free of cancer recurrence</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>   <span class="fu">branch</span>(</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>     <span class="at">option =</span> <span class="cf">function</span>(){</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>       <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim,</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>                     <span class="at">keys =</span> <span class="st">"AdjuvantCycleEvent"</span>) <span class="sc">==</span> <span class="dv">2</span></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>     },</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>     <span class="at">continue =</span> <span class="cn">FALSE</span>,</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>     traj_recurrence</span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>   ) <span class="sc">%&gt;%</span></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>   <span class="co">#check if max number of cycles reached</span></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>   <span class="fu">rollback</span>(</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>     <span class="at">target =</span> <span class="dv">5</span>,</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>     <span class="at">check =</span> <span class="cf">function</span>(){</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>       <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim, </span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>                     <span class="at">keys =</span> <span class="st">"AdjuavntCycles"</span>) <span class="sc">&lt;</span> m_max_adjuvant_cycles</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="long-term-follow-up" class="level3">
<h3 class="anchored" data-anchor-id="long-term-follow-up">Long-term follow-up</h3>
<p>If an individual did not receive adjuvant treatment or completed the maximum number of cycles, the long-term outcomes need to be determined based on two competing events: 1) <em>death</em> without cancer recurrence due to background mortality information; 2) <em>recurrence</em> at a certain point in time based on their time-to-recurrence information, after which they will be treated for the recurrence. After the <code>FollowUpTime</code> is determined, the impact in terms of QALYs is assessed and added to the <code>dQALYs</code> attribute (assume no costs for the long-term follow-up). After delaying the individual for the time-to-event, the event is to be processed using a branch, where deceased individuals are directed to the <code>traj_death</code> trajectory and individuals with a cancer recurrence to the <code>traj_recurrence</code> trajectory.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Long-term follow-up</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">#record time until recurrence or non-cancer death</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">#1=death, 2=recurrence</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">set_attribute</span>(</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"FollowUpTime"</span>, <span class="st">"FollowUpEvent"</span>),</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">values =</span> <span class="cf">function</span>() <span class="fu">c</span>(</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">FollowUpTime =</span> <span class="fu">min</span>(<span class="fu">get_attribute</span>(<span class="at">.env =</span> sim,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"BS"</span>, <span class="st">"RFS"</span>))) <span class="sc">-</span> </span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">now</span>(<span class="at">.env =</span> sim), <span class="at">FollowUpEvent =</span> <span class="fu">which.min</span>(</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim, <span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"BS"</span>, <span class="st">"RFS"</span>))</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="co">#update QALYs</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a> <span class="fu">set_attribute</span>(<span class="at">keys =</span> <span class="st">"dQALYs"</span>,</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">mod =</span> <span class="st">"+"</span>,</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>               <span class="at">values =</span> <span class="cf">function</span>() <span class="fu">fn_discount_QALYs</span>(</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">utility =</span> u_diseasefree,</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>                 <span class="at">t_start =</span> <span class="fu">now</span>(<span class="at">.env =</span> sim),</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>                 <span class="at">t_duration =</span> <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim,</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">keys =</span> <span class="st">"FollowUpTime"</span>))  </span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>                 ) <span class="sc">%&gt;%</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="co">#delay until death or cancer recurrence</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a> <span class="fu">timeout_from_attribute</span>(<span class="at">key =</span> <span class="st">"FollowUpTime"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a><span class="co">#check if event death or cancer recurrence</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a> <span class="co">#1=death, 2=recurrence   </span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a> <span class="fu">branch</span>(<span class="at">option =</span> <span class="cf">function</span>() <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim,</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">keys =</span> <span class="st">"FollowUpEvent"</span>),</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>        traj_death,</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        traj_recurrence</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>) <span class="co">#end of main trajectory  </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="recurrence" class="level3">
<h3 class="anchored" data-anchor-id="recurrence">Recurrence</h3>
<p>Upon cancer recurrence, individuals are directed to the <code>traj_recurrence</code> which processes the outcome and impact of treatment for advanced disease. When individuals have advanced cancer, they are at risk of dying from cancer and the cancer-specific survival has to be sampled and stored in the <code>CSS</code> attribute through the custom <code>fn_advanced_time()</code> function. After determining the impact of treatment for advanced disease, the individual is delayed for the duration of <code>CSS</code> using the <code>timeout_from_attribute()</code> function before directing it to the <code>traj_death</code> trajectory.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sub-trajectory for treatment of recurrence/advanced disease</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>traj_recurrence <span class="ot">&lt;-</span> <span class="fu">trajectory</span>(<span class="at">name =</span> <span class="st">"traj_recurrence"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#treatment of advanced disease</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">#record the time until death</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_attribute</span>(<span class="at">keys =</span> <span class="st">"CSS"</span>,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">values =</span> <span class="cf">function</span>() <span class="fu">fn_advanced_time</span>(</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">attrs =</span> <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim, </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"TreatmentArm"</span>, <span class="st">"BS"</span>))</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>                ) </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="co">#update costs and QALYs</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_attribute</span>(<span class="at">keys =</span> <span class="fu">c</span>(<span class="st">"dCosts"</span>, <span class="st">"dQALYs"</span>),</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">values =</span> <span class="fu">get_attribute</span>(<span class="at">.env =</span> sim, </span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">keys =</span> <span class="st">"CSS"</span>),</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>                <span class="at">mod =</span> <span class="st">"+"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="co">#delay until death</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">timeout_from_attribute</span>(<span class="at">key =</span> <span class="st">"CSS"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="co">#death: go to traj_death sub-trajectory </span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">join</span>(traj_death)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="death" class="level3">
<h3 class="anchored" data-anchor-id="death">Death</h3>
<p>At the end of the simulation, the overall survival is recorded in the <code>OS</code> attribute.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sub-trajectory to record survival upon death</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>traj_death <span class="ot">&lt;-</span> <span class="fu">trajectory</span>(<span class="at">name =</span> <span class="st">"traj_death"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">#record survival</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_attribute</span>(<span class="at">.env =</span> sim, </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">keys =</span> <span class="st">"OS"</span>,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">values =</span> <span class="cf">function</span>() <span class="fu">now</span>(<span class="at">.env =</span> sim))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="run-the-simulation" class="level3">
<h3 class="anchored" data-anchor-id="run-the-simulation">Run the simulation</h3>
<p>After defining the trajectory for the DES, the simulation environment can be defined and the simulation run. Using the <code>add_generator()</code> function, we define a prefix for the names of the individuals that they have to enter the <code>traj_main</code> trajectory and that the attributes are to be monitored throughout the simulation. After defining the simulation environment, the simulation can be run for each treatment separately and the simulation environment is rest using the <code>reset()</code> function before running the simulation using the <code>run()</code> function. The monitored attributes are then extracted using the custom <code>fn_summaries</code> function. The resulting data frames contain the individual-level HE outcomes, which can be aggregated to compare the different treatments.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define the simulation environment</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>n_individuals <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">simmer</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="at">name_prefix =</span> <span class="st">"Patient_"</span>,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">trajectory =</span> traj_main,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">distribution =</span> <span class="fu">at</span>(<span class="fu">rep</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">times =</span> n_individuals)),</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">mon =</span> <span class="dv">2</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co">#run the simulation and summarise outcomes for treatment None</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>treatment_arm <span class="ot">&lt;-</span> <span class="dv">0</span>; <span class="fu">set.seed</span>(<span class="dv">1</span>); sim <span class="sc">%&gt;%</span> <span class="fu">reset</span>() <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="cn">Inf</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>df_0 <span class="ot">&lt;-</span> <span class="fu">fn_summarise</span>(<span class="at">df_sim =</span> <span class="fu">get_mon_attributes</span>(sim))</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="co">#run the simulation and summarise outcomes for treatment A</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>treatment_arm <span class="ot">&lt;-</span> <span class="dv">1</span>; <span class="fu">set.seed</span>(<span class="dv">1</span>); sim <span class="sc">%&gt;%</span> <span class="fu">reset</span>() <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="cn">Inf</span>)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>df_1 <span class="ot">&lt;-</span> <span class="fu">fn_summarise</span>(<span class="at">df_sim =</span> <span class="fu">get_mon_attributes</span>(sim))</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="co">#run the simulation and summarise outcomes for treatment AB</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>treatment_arm <span class="ot">&lt;-</span> <span class="dv">2</span>; <span class="fu">set.seed</span>(<span class="dv">1</span>); sim <span class="sc">%&gt;%</span> <span class="fu">reset</span>() <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="cn">Inf</span>)</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>df_2 <span class="ot">&lt;-</span> <span class="fu">fn_summarise</span>(<span class="at">df_sim =</span> <span class="fu">get_mon_attributes</span>(sim))</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a><span class="co">#extract results</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>v_costs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(df_0<span class="sc">$</span>dCosts, <span class="fu">mean</span>(df_1<span class="sc">$</span>dCosts), <span class="fu">mean</span>(df_2<span class="sc">$</span>dCosts)))</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>v_effs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(df_0<span class="sc">$</span>dQALYs, <span class="fu">mean</span>(df_1<span class="sc">$</span>dQALYs), <span class="fu">mean</span>(df_2<span class="sc">$</span>dQALYs)))</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>v_strategies <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"None"</span>, <span class="st">"A"</span>, <span class="st">"AB"</span>)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>df_ce <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">"Costs"</span> <span class="ot">=</span> v_costs, <span class="st">"Effs"</span> <span class="ot">=</span> v_effs, <span class="st">"Strategies"</span> <span class="ot">=</span> v_strategies)</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a><span class="co">#get summaries</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">calculate_icers</span>(df_ce<span class="sc">$</span>Costs,df_ce<span class="sc">$</span>Effs,df_ce<span class="sc">$</span>Strategies)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="sec-paic" class="level1">
<h1>Population-Adjusted Indirect Comparisons</h1>
<section id="introduction-2" class="level2">
<h2 class="anchored" data-anchor-id="introduction-2">Introduction</h2>
<p>Standard NMA are widely used to estimate relative treatment effects between multiple treatments from several RCTs under the assumption that any effect-modifying variables are balanced between populations of the included trials. There are also methods that attempt to relax this assumption by accounting for effect modifiers in order to create population-adjusted estimates, mostly in terms of patient characteristics, differences in study-level effect modifiers related to the design of the trials (eg treatment administration). <em>Population-adjusted methods</em> are also used to incorporate single-arm studies or connect disconnected networks under stronger assumptions, and are seeing increasing use in HTA<span class="citation" data-cites="phillippo2018methods">(<a href="#ref-phillippo2018methods" role="doc-biblioref">Phillippo et al. 2018</a>)</span>. We fist outline the assumptions required to use these methods and list currently available approaches depending on the level of data available: full individual-level data; individual-level data from some studies and aggregate-level data from others; only aggregate-level data.</p>
<p>Covariate variables, included in the analysis in order to adjust the estimate a certain treatment effect of interest, may be effect modifiers, prognostic factors, or both and their interpretation is specific to the chosen effect measure scale. <em>Effect modifiers</em> are variables that alter the relative effect of a treatment on a given scale (eg odds ratios) so that treatment is more or less effective depending on the level of the effect modifier. <em>Prognostic factors</em> are variables that affect outcomes on all treatments equally. NMAs rely on assumption of exchangeability, ie relative treatment effects are the same across all included studies, also known as assumption of <em>constancy of relative effects</em>. This assumption may be violated if there are effect-modifiers present, which may lead to biased estimates. In addition, even if effect-modifiers are balanced between study populations, if these do not represent the target population for a treatment decision, then NMA estimates must be produced that are relevant to the decision target population.</p>
<p>With population-adjusted methods the objective is to estimate relative treatment effects for a target population of interest. In the case of a connected network, these methods attempt to adjust for effect-modifiers to relax the constancy assumption to <em>conditional constancy of relative effects</em> assumption, ie assume that relative effects can be predicted across populations based on the included effect-modifiers. This requires that all effect-modifiers are included and correctly specified in the analysis and may be violated in the presence of unobserved effect-modifiers that are unbalanced between populations.</p>
<p>Population-adjusted methods may also be used to incorporate single-arm studies or disconnected networks under a stronger assumption, known as <em>conditional constancy of absolute effects</em>. Based on this assumption, such analyses are defined either as <em>unanchored</em>, due to the lack of a common comparator to which analyses can be anchored, or <em>anchored</em>, due to the presence of a common comparator.</p>
</section>
<section id="methods-with-full-individual-level-data" class="level2">
<h2 class="anchored" data-anchor-id="methods-with-full-individual-level-data">Methods with full individual-level data</h2>
<p>In an ideal scenario, individual-level data are available from every study within an anchored network, in which case the “gold standard” for the analysis is an <em>individual-level network meta-regression for effect-modifiers</em><span class="citation" data-cites="berlin2002individual">(<a href="#ref-berlin2002individual" role="doc-biblioref">Berlin et al. 2002</a>)</span>. These analyses can be performed using standard software packages, such as the <code>multinma</code> package in <code>R</code>. In the case of an unanchored network, involving single-arm or observational studies, a range of methods based on the causal inference literature may be used<span class="citation" data-cites="faria2015nice">(<a href="#ref-faria2015nice" role="doc-biblioref">Faria et al. 2015</a>)</span>.</p>
</section>
<section id="methods-with-mixtures-of-individual-and-aggregate-level-data" class="level2">
<h2 class="anchored" data-anchor-id="methods-with-mixtures-of-individual-and-aggregate-level-data">Methods with mixtures of individual and aggregate-level data</h2>
<p>Several methods have been proposed for mixed data settings, which can be categorised as either <em>reweighting</em>-based or <em>regression</em>-based methods, which will be now briefly reviewed.</p>
<section id="matching-adjusted-indirect-comparison" class="level3">
<h3 class="anchored" data-anchor-id="matching-adjusted-indirect-comparison">Matching-Adjusted Indirect Comparison</h3>
<p><em>Matching-Adjusted Indirect Comparison</em> (MAIC) is a reweighting approach which derives weights for individuals in am individual-level study to match the summary statistics of covariates in an aggregate-level study<span class="citation" data-cites="ishak2015simulation">(<a href="#ref-ishak2015simulation" role="doc-biblioref">Ishak, Proskorovsky, and Benedict 2015</a>)</span>. MAIC is designed for a two-study scenario, where in anchored settings there is a single individual-level study comparing treatment B with A, and a single aggregate-level study comparing treatment C with A, so to obtain a comparison of C with B in the AC population. The individual-level study reports outcomes <span class="math inline">\(y_{ik(AB)}\)</span> and covariates <span class="math inline">\(x_{ik(AB)}\)</span> for each individual <span class="math inline">\(i\)</span> receiving treatment <span class="math inline">\(k\)</span> from the AB study population, while the aggregate-level study reports an estimated treatment effect <span class="math inline">\(\hat{\Delta}_{AC(AC)}=g(\bar{y}_{C(AC)})-g(\bar{y}_{A(AC)})\)</span> with standard errors <span class="math inline">\(s_{AC(AC)}\)</span> and summary covariates statistics <span class="math inline">\(\bar{x}_{(AC)}\)</span>. The relative treatment effect is taken on a suitable transformed scale given by the link function <span class="math inline">\(g(\cdot)\)</span>, eg logit.</p>
<p>MAIC estimates the expected outcomes <span class="math inline">\(\hat{y}_{k(AC)}\)</span> on treatments <span class="math inline">\(k=A,B\)</span> in the AC population as a weighted average of the individual outcomes in the AB population:</p>
<p><span class="math display">\[
\hat{y}_{k(AC)}=\frac{\sum_i y_{ik(AB)}w_{ik}}{\sum_i w_{ik}},
\]</span></p>
<p>where the participant weights <span class="math inline">\(w_{ik}\)</span> are often derived using the methods of moments. This is equivalent to a minimisation problem, where we want to minimise the overall difference between the reweighted covariate distribution and the AC summary statistics. After centring the covariates <span class="math inline">\(\bar{x}_{(AC)}=0\)</span>, the minimisation problem can be written as:</p>
<p><span class="math display">\[
\hat{\alpha}=\text{argmin}_{\alpha}\sum_{k=A,B}\sum_i\text{exp}(x_{ik}\alpha),
\]</span> where the weights are then equal to <span class="math inline">\(w_{ik}=\text{exp}(x_{ik(AB)}\hat{\alpha})\)</span>. Using this approach, MAIC estimates the population-averaged marginal relative effect <span class="math inline">\(\Delta_{BC(AC)}\)</span> of C vs B in the AC population in an anchored population-adjusted indirect comparison</p>
<p><span id="eq-1"><span class="math display">\[
\hat{\Delta}_{BS(AC)}=\hat{\Delta}_{AC(AC)}-\hat{\Delta}_{AB(AC)},
\tag{1}\]</span></span></p>
<p>where <span class="math inline">\(\hat{\Delta}_{AB(AC)}=g(\hat{y}_{B(AC)}-\hat{y}_{A(AC)})\)</span>.</p>
<p>In an unanchored setting, there is no common A arm, and the above approach derives the reweighted estimate <span class="math inline">\(\hat{y}_{B(C)}\)</span> before forming the unanchored population-adjusted indirect comparison with the estimated absolute outcomes on treatment C in the C population</p>
<p><span id="eq-2"><span class="math display">\[
\hat{\Delta}_{BC(C)}=g(\hat{y}_{C(C)}-\hat{y}_{B(C)}).
\tag{2}\]</span></span></p>
<p>Adequate prediction of absolute outcomes <span class="math inline">\(\hat{y}_{B(C)}\)</span> on treatment B in the C population not only requires accounting for differences in effect-modifiers between populations, but also prognostic factors that affect outcomes. Variance estimation for MAIC is often performed through either bootstrapping or robust sandwich estimators.</p>
<p>As a weighting approach, MAIC cannot extrapolate, which requires the aggregate-level AC population to have sufficient overlap with the individual-level AB population. The approximate effective sample size <span class="math inline">\(ESS=\frac{(\sum_{k=A,B}\sum_{i}w_{ik})^2}{\sum_{k=A,B}\sum_{i}w_{ik}}\)</span> and visual inspection of the weight distribution can be useful diagnostics, where extreme weights or large reductions in ESS indicating poor overlap. MAIC is designed with a two-study indirect comparison and does not generalise to larger networks.</p>
</section>
<section id="simulated-treatment-comparison" class="level3">
<h3 class="anchored" data-anchor-id="simulated-treatment-comparison">Simulated Treatment Comparison</h3>
<p><em>Simulated Treatment Comparison</em> (STC) is an outcome regression approach, where a regression model fitted to the individual-level study is used to produce predictions in the aggregated-level study population<span class="citation" data-cites="caro2010no">(<a href="#ref-caro2010no" role="doc-biblioref">Caro and Ishak 2010</a>)</span>. In an anchored STC, the predicted relative treatment effect of B vs A in the AC population is used to form an anchored population-adjusted indirect comparison as in <a href="#eq-1" class="quarto-xref">Equation&nbsp;1</a>, while in an unanchored STC, the predicted average absolute outcome on treatment B in the C population is used to form an unanchored indirect comparison as in <a href="#eq-2" class="quarto-xref">Equation&nbsp;2</a>.</p>
<p>Like MAIC, STC does not generalise to larger networks of studies or treatments, and can only produce estimates relevant to the aggregate-level study population. The most common form of anchored STC plugs-in mean covariate values from the AC population to obtain predicted outcomes on treatment A and B. However, when the model is non-linear in the covariates this results in aggregation bias, and when the outcome measure is non-collapsible (eg log odds ratios) it results in a biased indirect comparison. The original STC avoids this by simulating individuals from the AC study covariate distribution to calculate marginal relative effects <span class="math inline">\(\Delta_{AB(AC)}\)</span>.</p>
</section>
<section id="multilevel-network-meta-regression" class="level3">
<h3 class="anchored" data-anchor-id="multilevel-network-meta-regression">Multilevel Network Meta-Regression</h3>
<p><em>Multilevel Network Meta-Regression</em> (ML-NMR) is a population adjustment method that generalises standard netowrk meta-regression to scenarios where some studies only provide aggregate-level data<span class="citation" data-cites="phillippo2020multilevel">(<a href="#ref-phillippo2020multilevel" role="doc-biblioref">Phillippo et al. 2020</a>)</span>. ML-NMR defines an individual-level regression model as in an individual-level NMR, which models outcomes for individual <span class="math inline">\(i\)</span> in study <span class="math inline">\(j\)</span> receiving treatment <span class="math inline">\(k\)</span> as:</p>
<p><span class="math display">\[
\begin{aligned}
y_{ijk} &amp;\sim \pi_{I}(\theta_{ijk})\\
g(\theta_{ijk})&amp;=\eta_{jk}(x_{ijk})=\mu_j + x_{ijk}(\beta_1+\beta_{2,k}) + \gamma_k,
\end{aligned}
\]</span> where the individual outcomes are given suitable distributions <span class="math inline">\(\pi_{I}(\cdot)\)</span> with parameter <span class="math inline">\(\theta_{ijk}\)</span> modelled on a transformed linear predictor scale via the link function <span class="math inline">\(g(\cdot)\)</span>. The linear predictor <span class="math inline">\(\eta_{jk}(x_{ijk})\)</span> has stratified study-specific intercepts <span class="math inline">\(\mu_j\)</span> to preserve randomisation, prognostic covariate effects <span class="math inline">\(\beta_1\)</span>, effect-modifying interactions <span class="math inline">\(\beta_{2,k}\)</span>, and individual-level treatment effects <span class="math inline">\(\gamma_k\)</span>. Usually, we set <span class="math inline">\(\beta_{2,A}=0\)</span> and <span class="math inline">\(\gamma_A=0\)</span>.</p>
<p>To incorporate aggregate-level evidence, the individual-level model is integrated over the summary covariate distributions in the aggregate-level study to form the aggregate-level model:</p>
<p><span class="math display">\[
\begin{aligned}
y_{\cdot jk} &amp;\sim \pi_{A}(\theta_{\cdot jk})\\
\theta_{\cdot jk}&amp;=\int_{\zeta}g^{-1}(\eta_{jk}(x))f_{jk}(x)dx,
\end{aligned}
\]</span> where the subscript <span class="math inline">\(\cdot\)</span> denotes aggregate-level quantities. The marginalisation integral is usually evaluated by numerical methods such as <em>Quasi Monte Carlo</em> integration<span class="citation" data-cites="phillippo2020multilevel">(<a href="#ref-phillippo2020multilevel" role="doc-biblioref">Phillippo et al. 2020</a>)</span>. Fitting the ML-NMR requires the joint covariate distribution <span class="math inline">\(f_{jk}(x)\)</span> to be known in each aggregate-level study, but often only marginal summaries are available. The joint covariate distribution can be re-constructed from these summaries together with assumed forms for the marginal distributions and a correlation matrix using copulae. ML-NMR can produce population-adjusted estimates in any target population of interest <span class="math inline">\(P\)</span> with joint covariate distribution <span class="math inline">\(f_{P}(x)\)</span> between any pair of treatments <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> by integrating contrasts of the linear predictor on each treatment over the joint covariate distribution:</p>
<p><span class="math display">\[
d_{ab,P}=\int_{\zeta}(\eta_{b,P}(x)-\eta_{a,P}(x))f_{P}(x)dx=\bar{x}_P(\beta_{2,b}-\beta_{2,a})+\gamma_b-\gamma_a,
\]</span> which can be interpreted as the average of the individual-level treatment effects in population <span class="math inline">\(P\)</span>, when moving the population from treatment <span class="math inline">\(a\)</span> to <span class="math inline">\(b\)</span>. Note that the above computation requires information only on effect-modifying covariates in the target population, and not on the distribution of prognostic factors or baseline risk. Estimates of absolute outcomes, eg average event probabilities <span class="math inline">\(\bar{p}_{k,P}\)</span> for binary outcomes on each treatment <span class="math inline">\(k\)</span> in the population <span class="math inline">\(P\)</span>, are obtained via the marginalisation integral:</p>
<p><span id="eq-3"><span class="math display">\[
\bar{p}_{k,P} = \int_{\zeta}g^{-1}(\eta_{k,P}(x))f_{P}(x)dx.
\tag{3}\]</span></span></p>
<p>The full joint covariate distribution <span class="math inline">\(f_{P}(x)\)</span> is required and may be re-constructed from reported marginal summaries. This computation requires information on the distribution of both effect-modifying and prognostic covariates in the target population as well as the distribution of the individual-level baseline risk <span class="math inline">\(\mu_P\)</span>, often obtained from a distribution on the average event probabilities on any given reference treatment <span class="math inline">\(\bar{p}_{A,P}\)</span> by inverting <a href="#eq-3" class="quarto-xref">Equation&nbsp;3</a>. Population-average marginal treatment effects can then be obtained from the average absolute predictions.</p>
<p>NM-NMR can synthesise networks of any size and with any number of individual-level and aggregate-level studies but, where there is a small number of aggregate-level studies for a treatment requires an additional identifying assumption to estimate the corresponding treatment-covariate interactions for this treatment. Interaction terms may be assumed common for a set of treatments, an assumption known as <em>shared effect-modifier assumption</em>,thus allowing sharing of interaction effects with another treatment for which individual-level data are available or across multiple aggregate-level treatments.</p>
</section>
</section>
<section id="implementation-in-r-1" class="level2">
<h2 class="anchored" data-anchor-id="implementation-in-r-1">Implementation in <code>R</code></h2>
<p>We consider, as illustrative example, a network of treatments for moderate-to-severe plaque psoriasis<span class="citation" data-cites="phillippo2020multilevel">(<a href="#ref-phillippo2020multilevel" role="doc-biblioref">Phillippo et al. 2020</a>)</span>. A total of <span class="math inline">\(9\)</span> studies compared ixekizumab (IXE) every two weeks (Q2W) or four weeks (Q4W), secukinumab (SEC) at <span class="math inline">\(150\)</span> or <span class="math inline">\(300\)</span> mg dose, ustekinumab (UST) at a wight-based dose, and etanercept (ETN), along with placebo (PBO). These form the network, with individual-level data from four studies (UNCOVER-1,-2,-3,IXORA-S) and aggregate-level data from the remaining five studies (CLEAR,ERASURE,FEATURE,FIXTURE,JUNCTURE). Outcomes of interest included success/failure to achieve <span class="math inline">\(75\%\)</span> response on the psoriasis area and severity index (PASI) scale after <span class="math inline">\(12\)</span> weeks. Expert clinical opinion identified duration of psoriasis, previous systemic treartment, body surface area covered, weight, and psoriatic arthritis to be potential effect-modifiers. The individual-level outcomes/covariates and aggregate-level summaries are available in the <code>multinma</code> package in the objects <code>plaque_psoriasis_ipd</code> and <code>plaque_psoriasis_agd</code>, respectively. The first few rows of these data sets can be accessed by typing</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multinma) <span class="co">#load package</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co">#inspect data sets</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plaque_psoriasis_ipd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   studyc      trtc_long    trtc trtn pasi75 pasi90 pasi100 age  bmi pasi_w0
1 IXORA-S Ixekizumab Q2W IXE_Q2W    2      1      1       1  62 38.6    15.8
2 IXORA-S Ixekizumab Q2W IXE_Q2W    2      1      1       0  38 23.2    28.2
3 IXORA-S Ixekizumab Q2W IXE_Q2W    2      1      1       0  54 27.5    13.2
4 IXORA-S Ixekizumab Q2W IXE_Q2W    2      1      1       1  44 24.6    41.0
5 IXORA-S Ixekizumab Q2W IXE_Q2W    2      1      1       0  44 28.3    15.2
6 IXORA-S Ixekizumab Q2W IXE_Q2W    2      1      1       1  57 23.6    30.4
   male bsa weight durnpso prevsys   psa
1 FALSE  13  111.2       8    TRUE  TRUE
2 FALSE  37   62.0       1    TRUE FALSE
3  TRUE  13   83.5      38    TRUE FALSE
4 FALSE  67   66.0       1    TRUE FALSE
5 FALSE  10   92.7      23    TRUE FALSE
6 FALSE  75   73.5      21    TRUE FALSE</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plaque_psoriasis_agd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   studyc          trtc_long    trtc trtn pasi75_r pasi75_n pasi90_r pasi90_n
1   CLEAR Secukinumab 300 mg SEC_300    6      304      334      243      334
2   CLEAR        Ustekinumab     UST    7      265      335      179      335
3 ERASURE            Placebo     PBO    1       11      246        3      246
4 ERASURE Secukinumab 150 mg SEC_150    5      174      243       95      243
5 ERASURE Secukinumab 300 mg SEC_300    6      200      245      145      245
6 FEATURE            Placebo     PBO    1        0       59        0       59
  pasi100_r pasi100_n sample_size_w0 age_mean age_sd bmi_mean bmi_sd
1       130       334            337     45.2  13.96     29.1   5.87
2        86       335            339     44.6  13.67     29.0   6.69
3         2       246            248     45.4  12.60     30.3   7.80
4        31       243            245     44.9  13.30     29.8   6.80
5        70       245            245     44.9  13.50     30.3   7.20
6         0        59             59     46.5  14.14       NA     NA
  pasi_w0_mean pasi_w0_sd male bsa_mean bsa_sd weight_mean weight_sd
1         21.7       8.50 68.0     32.6  17.78        87.4     19.95
2         21.5       8.07 74.3     32.0  16.80        87.2     22.11
3         21.4       9.10 69.4     29.7  15.90        89.7     25.00
4         22.3       9.80 68.6     33.3  19.20        87.1     22.30
5         22.5       9.20 69.0     32.8  19.30        88.8     24.00
6         21.1       8.49 66.1     32.2  17.39        88.4     21.55
  durnpso_mean durnpso_sd prevsys  psa
1         19.6      12.90    66.8 20.5
2         16.1      11.24    68.1 15.9
3         17.3      12.40    58.9 27.4
4         17.5      12.00    63.7 18.8
5         17.4      11.10    66.5 23.3
6         20.2      14.22    66.1 15.3</code></pre>
</div>
</div>
<p>We will consider the target population to be the one of the PROSPECT cohort study conducted in <span class="math inline">\(335\)</span> sites across Germany<span class="citation" data-cites="thacci2020secukinumab">(<a href="#ref-thacci2020secukinumab" role="doc-biblioref">Thaçi et al. 2020</a>)</span>.</p>
<section id="anchored-maic" class="level3">
<h3 class="anchored" data-anchor-id="anchored-maic">Anchored MAIC</h3>
<p>For the anchored MAIC analysis we compare secukinumab 300 mg vs ixekizumab Q2W via etanercept as a common comparator. Two individual-level studies (UNCOVER-2,-3) compare ixekizumab to etanercept and one aggregate-level study (FIXTURE) compares secukinumab to etanercept. We will derive weights for each of the UNCOVER studies to match their covariate distributions with the FIXTURE population, with the indirect comparison performed on the probit scale. First, we prepare the data, selecting relevant rows from the data sets and check for no missing data.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#select rows</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>fixture_agd <span class="ot">&lt;-</span> <span class="fu">subset</span>(</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  plaque_psoriasis_agd, studyc <span class="sc">==</span> <span class="st">"FIXTURE"</span> <span class="sc">&amp;</span> trtc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ETN"</span>, <span class="st">"SEC_300"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>uncover_ipd <span class="ot">&lt;-</span> <span class="fu">subset</span>(</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  plaque_psoriasis_ipd, studyc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"UNCOVER-2"</span>, <span class="st">"UNCOVER-3"</span>) <span class="sc">&amp;</span> trtc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ETN"</span>, <span class="st">"IXE_Q2W"</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co">#check for no missing data</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(<span class="fu">complete.cases</span>(</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  uncover_ipd[, <span class="fu">c</span>(<span class="st">"pasi75"</span>, <span class="st">"durnpso"</span>, <span class="st">"prevsys"</span>, <span class="st">"bsa"</span>, <span class="st">"weight"</span>, <span class="st">"psa"</span>)]</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>We first centre the covariates around the values in the aggregate-level FIXTURE study: for continuous variables we match on the first and second moments (ie mean and variance).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#FIXTURE agg covariate summaries</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>X_agd <span class="ot">&lt;-</span> <span class="fu">with</span>(fixture_agd,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cbind</span>(durnpso_mean, durnpso_mean<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> durnpso_sd<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>                    prevsys <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>                    bsa_mean, bsa_mean<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> bsa_sd<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>                    weight_mean, weight_mean<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> weight_sd<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>                    psa <span class="sc">/</span> <span class="dv">100</span>))</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">#convert to summaries across all arms</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>X_agd <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  X_agd, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> weighted.mean, <span class="at">w =</span> fixture_agd<span class="sc">$</span>sample_size_w0</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="co">#create matrix of centred UNCOVER ind covariates</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>X_ipd <span class="ot">&lt;-</span> <span class="fu">sweep</span>(<span class="fu">with</span>(uncover_ipd,</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">cbind</span>(durnpso, durnpso<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>                          prevsys, bsa, bsa<span class="sc">^</span><span class="dv">2</span>, weight, weight<span class="sc">^</span><span class="dv">2</span>, psa)),</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">STATS =</span> X_agd, <span class="at">FUN =</span> <span class="st">"-"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then define the objective and gradient functions for optimisation to estimate the participant weights. We use optimisation to obtain weights for the UNCOVER studies, separately for each study, to ensure that each is matched to the FIXTURE population.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#objective function</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>objfn <span class="ot">&lt;-</span> <span class="cf">function</span>(a1, X){</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">exp</span>(X <span class="sc">%*%</span> a1))</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co">#gradient functions</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>gradfn <span class="ot">&lt;-</span> <span class="cf">function</span>(a1, X){</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colSums</span>(<span class="fu">sweep</span>(X, <span class="dv">1</span>, <span class="fu">exp</span>(X <span class="sc">%*%</span> a1), <span class="st">"*"</span>))</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>study_ipd <span class="ot">&lt;-</span> uncover_ipd<span class="sc">$</span>studyc</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co">#estimate weights for UNCOVER-2</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>opt_uncover2 <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(X_ipd)),</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fn =</span> objfn, <span class="at">gr =</span> gradfn,</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>                      <span class="at">X =</span> X_ipd[study_ipd <span class="sc">==</span> <span class="st">"UNCOVER-2"</span>, ],</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"BFGS"</span>)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>a1_uncover2 <span class="ot">&lt;-</span> opt_uncover2<span class="sc">$</span>par</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>wt_uncover2 <span class="ot">&lt;-</span> <span class="fu">exp</span>(X_ipd[study_ipd <span class="sc">==</span> <span class="st">"UNCOVER-2"</span>, ] <span class="sc">%*%</span> a1_uncover2)</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="co">#normalise to sum to ESS </span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>wt_uncover2 <span class="ot">&lt;-</span> wt_uncover2 <span class="sc">*</span> <span class="fu">sum</span>(wt_uncover2) <span class="sc">/</span> <span class="fu">sum</span>(wt_uncover2<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="co">#do the same for UNCOVER-3</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>opt_uncover3 <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(X_ipd)),</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fn =</span> objfn, <span class="at">gr =</span> gradfn,</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>                      <span class="at">X =</span> X_ipd[study_ipd <span class="sc">==</span> <span class="st">"UNCOVER-3"</span>, ],</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"BFGS"</span>)</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>a1_uncover3 <span class="ot">&lt;-</span> opt_uncover3<span class="sc">$</span>par</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>wt_uncover3 <span class="ot">&lt;-</span> <span class="fu">exp</span>(X_ipd[study_ipd <span class="sc">==</span> <span class="st">"UNCOVER-3"</span>, ] <span class="sc">%*%</span> a1_uncover3)</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>wt_uncover3 <span class="ot">&lt;-</span> wt_uncover3 <span class="sc">*</span> <span class="fu">sum</span>(wt_uncover3) <span class="sc">/</span> <span class="fu">sum</span>(wt_uncover3<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We now examine the histograms of the weights and calculate the effective sample sizes.</p>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#histograms of the weights</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(wt_uncover2, <span class="at">freq =</span> <span class="cn">FALSE</span>, <span class="at">breaks =</span> <span class="dv">50</span>, <span class="at">main =</span> <span class="cn">NULL</span>, <span class="at">xlab =</span> <span class="st">"weight"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(wt_uncover3, <span class="at">freq =</span> <span class="cn">FALSE</span>, <span class="at">breaks =</span> <span class="dv">50</span>, <span class="at">main =</span> <span class="cn">NULL</span>, <span class="at">xlab =</span> <span class="st">"weight"</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">#ESS</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(wt_uncover2)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fu">sum</span>(wt_uncover2<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(wt_uncover3)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fu">sum</span>(wt_uncover3<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<pre><code>[1] 406.422</code></pre>
</div>
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<pre><code>[1] 564.3352</code></pre>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-maic1-1" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-maic1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="code3_files/figure-html/fig-maic1-1.png" id="fig-maic1-1" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-maic1-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-maic1-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-maic1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="code3_files/figure-html/fig-maic1-2.png" id="fig-maic1-2" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-maic1-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>The lack of extreme weights and reasonable ESS in absolute terms do not highlight any specific problem. We then estimate the treatment effect of ixekizumab vs etanercept on the probit scale as a probit difference, interpreted as a standardised mean difference, using a weighted binomial GLM with probit link function and robust sandwich standard errors within each of the studies reweighted samples. Alternatively, bootstrapping can be performed. We combine the estimates with an inverse-variance meta-analysis (fixed effects) to obtain the overall estimate on the probit scale in the FIXTURE population.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich) <span class="co">#load package</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co">#IXE Q2W vs ETN from UNCOVER-2</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co">#fit glm </span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>fit_uncover2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(pasi75, <span class="dv">1</span><span class="sc">-</span>pasi75) <span class="sc">~</span> trtc,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> uncover_ipd[study_ipd <span class="sc">==</span> <span class="st">"UNCOVER-2"</span>, ],</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>),</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> wt_uncover2</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co">#get probit diff</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>d_uncover2 <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_uncover2)[<span class="st">"trtcIXE_Q2W"</span>]</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="co">#sanwich variance estimator</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>var_uncover2 <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(fit_uncover2)[<span class="st">"trtcIXE_Q2W"</span>, <span class="st">"trtcIXE_Q2W"</span>]</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="co">#IXE Q2W vs ETN from UNCOVER-3</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="co">#fit glm </span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>fit_uncover3 <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(pasi75, <span class="dv">1</span><span class="sc">-</span>pasi75) <span class="sc">~</span> trtc,</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> uncover_ipd[study_ipd <span class="sc">==</span> <span class="st">"UNCOVER-3"</span>, ],</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>),</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> wt_uncover3</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a><span class="co">#get probit diff</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>d_uncover3 <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_uncover3)[<span class="st">"trtcIXE_Q2W"</span>]</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a><span class="co">#sanwich variance estimator</span></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>var_uncover3 <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(fit_uncover3)[<span class="st">"trtcIXE_Q2W"</span>, <span class="st">"trtcIXE_Q2W"</span>]</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a><span class="co">#get inverse-variance weighted estimate and SE</span></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>d_ETN_IXE <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(<span class="fu">c</span>(d_uncover2, d_uncover3),</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">c</span>(<span class="dv">1</span> <span class="sc">/</span> var_uncover2, <span class="dv">1</span> <span class="sc">/</span> var_uncover3))</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>d_ETN_IXE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.280599</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>se_ETN_IXE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">/</span> var_uncover2, <span class="dv">1</span> <span class="sc">/</span> var_uncover3))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>se_ETN_IXE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.09742977</code></pre>
</div>
</div>
<p>The estimated probit difference and standard error for secukinumab vs etanercept from the FIXTURE study is the computed as</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>fit_fixture <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">cbind</span>(pasi75_r, pasi75_n <span class="sc">-</span> pasi75_r) <span class="sc">~</span> trtc,</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> fixture_agd,</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>))</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>d_ETN_SEC <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_fixture)[[<span class="st">"trtcSEC_300"</span>]]</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>d_ETN_SEC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8937181</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>se_ETN_SEC <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">vcov</span>(fit_fixture)[<span class="st">"trtcSEC_300"</span>, <span class="st">"trtcSEC_300"</span>])</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>se_ETN_SEC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.104214</code></pre>
</div>
</div>
<p>Finally, we construct the population-adjusted indirect comparison of ixekizumab vs secukinumab in the FIXTURE population</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>d_SEC_IXE <span class="ot">&lt;-</span> d_ETN_IXE <span class="sc">-</span> d_ETN_SEC</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>d_SEC_IXE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3868807</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>se_SEC_IXE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(se_ETN_IXE<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> se_ETN_SEC<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>se_SEC_IXE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1426643</code></pre>
</div>
</div>
<p>A key limitation of MAIC is that it is only valid for the FIXTURE population, but this is not representative of the selected decision target population (PROSPECT). In addition, we did no use all available data, since two individual-level studies and four aggregate-level studies were excluded since they did not have an etanercept arm.</p>
</section>
<section id="unacnhored-maic" class="level3">
<h3 class="anchored" data-anchor-id="unacnhored-maic">Unacnhored MAIC</h3>
<p>In the event no common comparators are available in the network, an unanchored MAIC analysis may be conducted. The <code>R</code> coded is mostly the same as for the anchored analysis, so that the code for the data setup and weights derivation is not repeated here. After obtaining weights matching the UNCOVER-2 (<code>wt_IXE_uncover2</code>) and UNCOVER-3 (<code>wt_IXE_uncover3</code>) ixekizumab Q2W arms to the FIXTURE secukinumab 300 mg arm, these are used to estimate the average absolute outcomes on ixekizumab Q2W in the FIXTURE population.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">#IXE Q2W prob from UNCOVER-2</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>fit_IXE_uncover2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(pasi75, <span class="dv">1</span><span class="sc">-</span>pasi75 <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">subset</span>(uncover_ipd, <span class="at">studyc =</span> <span class="st">"UNCOVER-2"</span> <span class="sc">&amp;</span> <span class="at">trtc =</span> <span class="st">"IXE_Q2W"</span>),</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>),</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">weights =</span> wt_IXE_uncover2)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="co">#probit prob</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>p_IXE_uncover2 <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_IXE_uncover2)[[<span class="st">"(Intercept)"</span>]]</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="co">#sandwich variance</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>var_IXE_uncover2 <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(fit_IXE_uncover2[<span class="st">"(Intercept)"</span>, <span class="st">"(Intercept)"</span>])</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="co">#IXE Q2W prob from UNCOVER-3</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>fit_IXE_uncover2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(pasi75, <span class="dv">1</span><span class="sc">-</span>pasi75 <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">subset</span>(uncover_ipd, <span class="at">studyc =</span> <span class="st">"UNCOVER-3"</span> <span class="sc">&amp;</span> <span class="at">trtc =</span> <span class="st">"IXE_Q2W"</span>),</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>),</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">weights =</span> wt_IXE_uncover3)</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a><span class="co">#probit prob</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>p_IXE_uncover3 <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_IXE_uncover3)[[<span class="st">"(Intercept)"</span>]]</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a><span class="co">#sandwich variance</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>var_IXE_uncover3 <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(fit_IXE_uncover3[<span class="st">"(Intercept)"</span>, <span class="st">"(Intercept)"</span>])</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a><span class="co">#get inverse-variance weighted estimate and SE</span></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>p_IXE <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(<span class="fu">c</span>(p_IXE_uncover2, p_IXE_uncover3),</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">c</span>(<span class="dv">1</span> <span class="sc">/</span> var_IXE_uncover2, <span class="dv">1</span> <span class="sc">/</span> var_IXE_uncover3))</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>se_IXE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">/</span> var_IXE_uncover2, <span class="dv">1</span> <span class="sc">/</span> var_IXE_uncover3))</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a><span class="co">#probit event prob and SE for SEC from FIXTURE</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>fit_SEC_fixture <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">cbind</span>(pasi75_r, pasi75_n <span class="sc">-</span> pasi75_r) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> fixture_agd,</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>                       <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>))</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>p_SEC <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_SEC_fixture)[[<span class="st">"(Intercept)"</span>]]</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>se_SEC <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">vcov</span>(fit_SEC_fixture[<span class="st">"(Intercept)"</span>, <span class="st">"(Intercept)"</span>])) </span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a><span class="co">#get unanchored pop-adjusted indirect comparison of IXE vs SEC in FIXTURE population</span></span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>d_un_SEC_IXE <span class="ot">&lt;-</span> p_IXE <span class="sc">-</span> p_SEC <span class="co">#probit diff</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>se_un_SEC_IXE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(se_IXE<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> se_SEC<span class="sc">^</span><span class="dv">2</span>) <span class="co">#se</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Unanchored MAIC estimates rely on much stronger assumptions that absolute outcomes can be predicted based on the included covariates, with also the usual limitation that such estimates are only relevant to the FIXTURE population and not the target population (PROSPECT).</p>
</section>
<section id="ml-nmr" class="level3">
<h3 class="anchored" data-anchor-id="ml-nmr">ML-NMR</h3>
<p>We now use ML-NMR to analyse this network of evidence, allowing comparisons between any pair of treatments in the network as well as generation of estimates in any target population of interest. ML-NMR is implemented in the <code>multinma</code> package. After loading the package, we start by preparing the data by transforming the covariates so that binary variables or percentages are given as proportions and continuous covariates are approximately unit scaled. These changes are made to improve computational efficiency, and we also add a variable describing the treatment classes. Individuals with missing values for some covariates are excluded.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multinma) <span class="co">#load package</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()) <span class="co">#run chains in parallel to improve efficiency</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Ind studies</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>pso_ipd <span class="ot">&lt;-</span> <span class="fu">transform</span>(plaque_psoriasis_ipd,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">bsa =</span> bsa <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight =</span> weight <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">durnpso =</span> durnpso <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">prevsys =</span> <span class="fu">as.numeric</span>(prevsys),</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">psa =</span> <span class="fu">as.numeric</span>(psa),</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">trtclass =</span> <span class="fu">ifelse</span>(trtc <span class="sc">==</span> <span class="st">"PBO"</span>, <span class="st">"Placebo"</span>,</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ifelse</span>(trtc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"IXE_Q2W"</span>,<span class="st">"IXE_Q4W"</span>,<span class="st">"SEX_150"</span>,<span class="st">"SEC_300"</span>),</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"IL-17-blocker"</span>,</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">ifelse</span>(trtc <span class="sc">==</span> <span class="st">"ETN"</span>, <span class="st">"TNFa blocker"</span>,</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">ifelse</span>(trtc <span class="sc">==</span> <span class="st">"UST"</span>, <span class="st">"IL-12/23 blocker"</span>, <span class="cn">NA</span>)))),</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="at">is_complete =</span> <span class="fu">complete.cases</span>(durnpso, prevsys, bsa, weight, psa))</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co">#remove incomplete cases</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>pso_ipd <span class="ot">&lt;-</span> <span class="fu">subset</span>(pso_ipd, is_complete)</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="co">#Agg studies</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>pso_agd <span class="ot">&lt;-</span> <span class="fu">transform</span>(plaque_psoriasis_agd,</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">bsa_mean =</span> bsa_mean <span class="sc">/</span> <span class="dv">100</span>, </span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">bsa_sd =</span> bsa_sd <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight_mean =</span> weight_mean <span class="sc">/</span><span class="dv">10</span>, </span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight_sd =</span> weight_sd <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">durnpso_mean =</span> durnpso_mean <span class="sc">/</span> <span class="dv">10</span>, </span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">durnpso_sd =</span> durnpso_sd <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">prevsys =</span> prevsys <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">psa =</span> psa <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">trtclass =</span> <span class="fu">ifelse</span>(trtc <span class="sc">==</span> <span class="st">"PBO"</span>, <span class="st">"Placebo"</span>,</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ifelse</span>(trtc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"IXE_Q2W"</span>, <span class="st">"IXE_Q4W"</span>, <span class="st">"SEC_150"</span>, <span class="st">"SEC_300"</span>),</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"IL-17 blocker"</span>,</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">ifelse</span>(trtc <span class="sc">==</span> <span class="st">"ETN"</span>, <span class="st">"TNFa blocker"</span>,</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">ifelse</span>(trtc <span class="sc">==</span> <span class="st">"UST"</span>, <span class="st">"IL-12/23 blocker"</span>, <span class="cn">NA</span>))))</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can then set up the network using the <code>set_ipd()</code> and <code>set_agd_arm()</code> functions to define the two data sources, and then use the <code>combine_network()</code> function to bring them together. We can then plot the network diagram using the <code>plot</code> function, which produces the graph shown in <a href="#fig-mlnmr1" class="quarto-xref">Figure&nbsp;5</a>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set up network of ind and agg data</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>pso_net <span class="ot">&lt;-</span> <span class="fu">combine_network</span>(</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_ipd</span>(pso_ipd,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">study =</span> studyc,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">trt =</span> trtc,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">r =</span> pasi75,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">trt_class =</span> trtclass),</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_agd_arm</span>(pso_agd,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">study =</span> studyc,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">trt =</span> trtc,</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">r =</span> pasi75_r,</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">n =</span> pasi75_n,</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">trt_class =</span> trtclass)</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="co">#create a network diagram</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pso_net, <span class="at">weight_edges =</span> <span class="cn">TRUE</span>, <span class="at">weight_nodes =</span> <span class="cn">TRUE</span>, <span class="at">show_trt_class =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mlnmr1" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mlnmr1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="code3_files/figure-html/fig-mlnmr1-1.png" id="fig-mlnmr1" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-mlnmr1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5
</figcaption>
</figure>
</div>
</div>
</div>
<p>To include the aggregate studies within the model, we need to set up the covariates for numerical integration through the <code>add_integration()</code> function, specifying: duration and weight to have a Gamma distribution to handle skewness in the individual-level data; body surface to have a logit-Normal distrbution; previous systemic treatment and plaque psoriasis to have a Bernoulli distribution.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#assign distributions for variables' integration in the model</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>pso_net <span class="ot">&lt;-</span> <span class="fu">add_integration</span>(pso_net,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">durnpso =</span> <span class="fu">distr</span>(qgamma, <span class="at">mean =</span> durnpso_mean, <span class="at">sd =</span> durnpso_sd),</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">prevsys =</span> <span class="fu">distr</span>(qbern, <span class="at">prob =</span> prevsys),</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">bsa =</span> <span class="fu">distr</span>(qlogitnorm, <span class="at">mean =</span> bsa_mean, <span class="at">sd =</span> bsa_sd),</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">weight =</span> <span class="fu">distr</span>(qgamma, <span class="at">mean =</span> weight_mean, <span class="at">sd =</span> weight_sd),</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">psa =</span> <span class="fu">distr</span>(qbern, <span class="at">prob =</span> psa))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We fit ML-NMR model to this network using the <code>nma()</code> function, specifying: a regression model including main covariate effects and treatment-covariate interactions; a probit link function with the two parameter Bernoulli approximation for the aggregate-level distribution; a shared effect-modifier assumption to identify all interaction terms; weakly informative priors on each parameter; set random initial values and QR decomposition to improve sampling efficiency.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co">#fit ML-NRM model</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>pso_fit_FE <span class="ot">&lt;-</span> <span class="fu">nma</span>(pso_net,</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trt_effects =</span> <span class="st">"fixed"</span>,</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">link =</span> <span class="st">"probit"</span>,</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">likelihood =</span> <span class="st">"bernoulli2"</span>,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">regression =</span> <span class="sc">~</span>(durnpso <span class="sc">+</span> prevsys <span class="sc">+</span> bsa <span class="sc">+</span> weight <span class="sc">+</span> psa)<span class="sc">*</span>.trt,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">class_interactions =</span> <span class="st">"common"</span>,</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="at">scale =</span> <span class="dv">10</span>),</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prior_trt =</span> <span class="fu">normal</span>(<span class="at">scale =</span> <span class="dv">10</span>),</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prior_reg =</span> <span class="fu">normal</span>(<span class="at">scale =</span> <span class="dv">10</span>),</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">init_r =</span> <span class="fl">0.1</span>, <span class="at">QR =</span> <span class="cn">TRUE</span>,</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">chains =</span> <span class="dv">2</span>, <span class="at">iter =</span> <span class="dv">200</span> <span class="co">#set n chains and iterations</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Parameter summaries can now be obtained for each parameter using the <code>print</code> function, for example for the individual-level treatment effects called “d”.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">#print posterior summaries</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pso_fit_FE, <span class="at">pars =</span> <span class="st">"d"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>A fixed effects ML-NMR with a bernoulli2 likelihood (probit link).
Regression model: ~(durnpso + prevsys + bsa + weight + psa) * .trt.
Centred covariates at the following overall mean values:
  durnpso   prevsys       bsa    weight       psa 
1.7947485 0.6504375 0.2973544 8.9165934 0.2074278 
Inference for Stan model: binomial_2par.
2 chains, each with iter=200; warmup=100; thin=1; 
post-warmup draws per chain=100, total post-warmup draws=200.

           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat
d[ETN]     1.55    0.01 0.07 1.43 1.49 1.54 1.59  1.69   126 1.00
d[IXE_Q2W] 2.96    0.01 0.08 2.79 2.91 2.97 3.02  3.12    83 1.00
d[IXE_Q4W] 2.54    0.01 0.08 2.38 2.49 2.54 2.59  2.68   130 0.99
d[SEC_150] 5.68    0.14 0.39 4.88 5.46 5.72 5.94  6.31     8 1.22
d[SEC_300] 7.78    0.14 0.51 6.60 7.55 7.89 8.14  8.55    13 1.13
d[UST]     2.04    0.02 0.20 1.64 1.91 2.04 2.18  2.45    95 0.99

Samples were drawn using NUTS(diag_e) at Fri Nov  7 17:39:13 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>We can then obtain population-average conditional relative treatment effects, predictions of absolute outcomes, and population-average marginal treatment effects for each of the study populations in the network</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">#relative effects</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">relative_effects</span>(pso_fit_FE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>------------------------------------------------------------------ Study: CLEAR ---- 

Covariate values:
 durnpso prevsys  bsa weight  psa
    1.73    0.66 0.32   8.74 0.16

                  mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS Rhat
d[CLEAR: ETN]     1.59 0.07 1.47 1.53 1.58 1.63  1.75      126       84 1.00
d[CLEAR: IXE_Q2W] 2.99 0.09 2.82 2.93 2.99 3.05  3.16       79      114 1.02
d[CLEAR: IXE_Q4W] 2.57 0.08 2.41 2.52 2.57 2.62  2.73      125      110 1.01
d[CLEAR: SEC_150] 5.43 0.36 4.76 5.20 5.49 5.65  6.07        9       48 1.19
d[CLEAR: SEC_300] 7.53 0.46 6.49 7.36 7.60 7.84  8.17       20       54 1.15
d[CLEAR: UST]     2.03 0.20 1.65 1.91 2.04 2.17  2.42       92      110 1.02

---------------------------------------------------------------- Study: ERASURE ---- 

Covariate values:
 durnpso prevsys  bsa weight  psa
    1.69    0.61 0.32   8.86 0.23

                    mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS Rhat
d[ERASURE: ETN]     1.55 0.07 1.42 1.50 1.54 1.60  1.70      126      122 1.00
d[ERASURE: IXE_Q2W] 2.97 0.09 2.81 2.92 2.98 3.03  3.14       81      114 1.02
d[ERASURE: IXE_Q4W] 2.55 0.08 2.39 2.51 2.55 2.61  2.69      125      110 1.00
d[ERASURE: SEC_150] 5.08 0.40 4.33 4.79 5.09 5.36  5.82        5       23 1.42
d[ERASURE: SEC_300] 7.18 0.49 6.17 6.90 7.30 7.47  7.97        8       24 1.21
d[ERASURE: UST]     2.03 0.21 1.63 1.89 2.04 2.18  2.45      108      110 1.01

---------------------------------------------------------------- Study: FEATURE ---- 

Covariate values:
 durnpso prevsys  bsa weight  psa
     1.9    0.67 0.32   9.17 0.15

                    mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS Rhat
d[FEATURE: ETN]     1.51 0.07 1.40 1.46 1.50 1.56  1.67      134      130 1.00
d[FEATURE: IXE_Q2W] 2.95 0.09 2.78 2.89 2.94 3.01  3.10       80      113 1.00
d[FEATURE: IXE_Q4W] 2.53 0.08 2.37 2.48 2.53 2.58  2.66      133      120 1.01
d[FEATURE: SEC_150] 6.79 0.45 5.89 6.47 6.90 7.08  7.53        8       44 1.21
d[FEATURE: SEC_300] 8.89 0.55 7.61 8.66 9.02 9.27  9.69       19       54 1.14
d[FEATURE: UST]     1.98 0.20 1.58 1.85 1.98 2.13  2.38       88       90 1.01

---------------------------------------------------------------- Study: FIXTURE ---- 

Covariate values:
 durnpso prevsys  bsa weight  psa
     1.6    0.62 0.34   8.34 0.14

                    mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS Rhat
d[FIXTURE: ETN]     1.65 0.08 1.52 1.59 1.64 1.70  1.84      118       84 1.00
d[FIXTURE: IXE_Q2W] 3.04 0.10 2.86 2.97 3.03 3.10  3.24       76      106 1.03
d[FIXTURE: IXE_Q4W] 2.62 0.09 2.44 2.56 2.61 2.68  2.78      109       81 1.00
d[FIXTURE: SEC_150] 4.39 0.29 3.86 4.21 4.39 4.60  4.93       11       46 1.16
d[FIXTURE: SEC_300] 6.49 0.38 5.74 6.27 6.51 6.81  7.03       18       44 1.18
d[FIXTURE: UST]     2.02 0.20 1.65 1.88 2.03 2.15  2.41       93      104 1.03

---------------------------------------------------------------- Study: IXORA-S ---- 

Covariate values:
 durnpso prevsys  bsa weight  psa
    1.67    0.92 0.32   8.78 0.13

                    mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS Rhat
d[IXORA-S: ETN]     1.63 0.09 1.49 1.56 1.61 1.69  1.85      138       83 1.01
d[IXORA-S: IXE_Q2W] 3.01 0.10 2.83 2.94 3.01 3.07  3.17       89       93 1.01
d[IXORA-S: IXE_Q4W] 2.59 0.09 2.43 2.53 2.58 2.64  2.80      122       95 1.00
d[IXORA-S: SEC_150] 5.67 0.57 4.63 5.24 5.69 6.12  6.68        4       24 1.54
d[IXORA-S: SEC_300] 7.76 0.58 6.51 7.48 7.88 8.20  8.62        6       24 1.35
d[IXORA-S: UST]     2.19 0.21 1.72 2.04 2.23 2.32  2.60       89      108 1.00

--------------------------------------------------------------- Study: JUNCTURE ---- 

Covariate values:
 durnpso prevsys  bsa weight  psa
    1.99    0.55 0.27   9.17 0.23

                     mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS Rhat
d[JUNCTURE: ETN]     1.48 0.08 1.35 1.42 1.48 1.53  1.61      125      130 1.01
d[JUNCTURE: IXE_Q2W] 2.92 0.09 2.73 2.86 2.92 2.98  3.05       89       96 1.00
d[JUNCTURE: IXE_Q4W] 2.50 0.08 2.34 2.44 2.51 2.56  2.62      135      106 1.00
d[JUNCTURE: SEC_150] 6.57 0.47 5.65 6.26 6.59 6.89  7.41       14       56 1.11
d[JUNCTURE: SEC_300] 8.67 0.64 7.35 8.26 8.61 9.22  9.67       15       33 1.36
d[JUNCTURE: UST]     1.95 0.23 1.53 1.79 1.96 2.12  2.40      107      107 1.01

-------------------------------------------------------------- Study: UNCOVER-1 ---- 

Covariate values:
 durnpso prevsys  bsa weight  psa
       2    0.73 0.28   9.24 0.28

                      mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
d[UNCOVER-1: ETN]     1.50 0.07 1.38 1.45 1.49 1.55  1.63      150      126
d[UNCOVER-1: IXE_Q2W] 2.93 0.08 2.76 2.87 2.93 2.99  3.08       86      115
d[UNCOVER-1: IXE_Q4W] 2.50 0.07 2.35 2.46 2.51 2.55  2.64      139      129
d[UNCOVER-1: SEC_150] 6.59 0.52 5.54 6.34 6.66 6.97  7.35        7       30
d[UNCOVER-1: SEC_300] 8.69 0.64 7.30 8.38 8.79 9.17  9.62       10       48
d[UNCOVER-1: UST]     2.11 0.21 1.70 1.97 2.11 2.28  2.51      123      109
                      Rhat
d[UNCOVER-1: ETN]     1.00
d[UNCOVER-1: IXE_Q2W] 1.00
d[UNCOVER-1: IXE_Q4W] 1.00
d[UNCOVER-1: SEC_150] 1.25
d[UNCOVER-1: SEC_300] 1.16
d[UNCOVER-1: UST]     1.00

-------------------------------------------------------------- Study: UNCOVER-2 ---- 

Covariate values:
 durnpso prevsys  bsa weight  psa
    1.87    0.64 0.27   9.17 0.24

                      mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
d[UNCOVER-2: ETN]     1.50 0.07 1.37 1.44 1.49 1.55  1.63      142      128
d[UNCOVER-2: IXE_Q2W] 2.92 0.08 2.74 2.87 2.93 2.98  3.07       94      114
d[UNCOVER-2: IXE_Q4W] 2.50 0.08 2.35 2.46 2.51 2.55  2.64      142      130
d[UNCOVER-2: SEC_150] 6.19 0.46 5.26 5.97 6.25 6.51  6.95        6       19
d[UNCOVER-2: SEC_300] 8.29 0.60 7.04 7.98 8.34 8.77  9.22        9       49
d[UNCOVER-2: UST]     2.04 0.21 1.62 1.90 2.04 2.21  2.46      105       90
                      Rhat
d[UNCOVER-2: ETN]     1.00
d[UNCOVER-2: IXE_Q2W] 1.00
d[UNCOVER-2: IXE_Q4W] 1.00
d[UNCOVER-2: SEC_150] 1.26
d[UNCOVER-2: SEC_300] 1.19
d[UNCOVER-2: UST]     1.01

-------------------------------------------------------------- Study: UNCOVER-3 ---- 

Covariate values:
 durnpso prevsys  bsa weight psa
    1.78    0.59 0.28   9.01 0.2

                      mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
d[UNCOVER-3: ETN]     1.52 0.07 1.40 1.46 1.51 1.57  1.65      124      131
d[UNCOVER-3: IXE_Q2W] 2.94 0.08 2.77 2.89 2.94 3.00  3.09       94      114
d[UNCOVER-3: IXE_Q4W] 2.52 0.08 2.36 2.47 2.53 2.58  2.65      141      110
d[UNCOVER-3: SEC_150] 5.78 0.40 4.99 5.57 5.83 6.06  6.43        8       30
d[UNCOVER-3: SEC_300] 7.88 0.54 6.66 7.58 7.96 8.30  8.75       11       47
d[UNCOVER-3: UST]     1.99 0.21 1.57 1.85 2.00 2.14  2.43      102       90
                      Rhat
d[UNCOVER-3: ETN]     1.00
d[UNCOVER-3: IXE_Q2W] 1.00
d[UNCOVER-3: IXE_Q4W] 1.00
d[UNCOVER-3: SEC_150] 1.21
d[UNCOVER-3: SEC_300] 1.20
d[UNCOVER-3: UST]     1.02</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">#avg event probs</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(pso_fit_FE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>------------------------------------------------------------------ Study: CLEAR ---- 

                      mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS Tail_ESS
pred[CLEAR: PBO]     -1.12 0.20 -1.54 -1.24 -1.12 -0.97 -0.74       63       79
pred[CLEAR: ETN]      0.47 0.20  0.13  0.33  0.46  0.63  0.84       65      137
pred[CLEAR: IXE_Q2W]  1.88 0.18  1.53  1.74  1.86  2.01  2.23       69      132
pred[CLEAR: IXE_Q4W]  1.45 0.20  1.07  1.31  1.44  1.60  1.82       76      183
pred[CLEAR: SEC_150]  4.31 0.33  3.71  4.12  4.33  4.55  4.92        9       82
pred[CLEAR: SEC_300]  6.41 0.46  5.37  6.15  6.46  6.76  7.17       21       64
pred[CLEAR: UST]      0.92 0.10  0.75  0.85  0.91  0.98  1.11      118       75
                     Rhat
pred[CLEAR: PBO]     1.05
pred[CLEAR: ETN]     1.03
pred[CLEAR: IXE_Q2W] 1.01
pred[CLEAR: IXE_Q4W] 1.01
pred[CLEAR: SEC_150] 1.16
pred[CLEAR: SEC_300] 1.08
pred[CLEAR: UST]     1.03

---------------------------------------------------------------- Study: ERASURE ---- 

                        mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS
pred[ERASURE: PBO]     -1.77 0.14 -2.03 -1.87 -1.77 -1.67 -1.52       85
pred[ERASURE: ETN]     -0.22 0.16 -0.47 -0.33 -0.21 -0.11  0.09       80
pred[ERASURE: IXE_Q2W]  1.20 0.14  0.96  1.11  1.20  1.29  1.47      107
pred[ERASURE: IXE_Q4W]  0.78 0.15  0.53  0.68  0.77  0.91  1.09       96
pred[ERASURE: SEC_150]  3.31 0.37  2.61  3.06  3.32  3.56  3.97        5
pred[ERASURE: SEC_300]  5.41 0.47  4.28  5.18  5.48  5.74  6.22        9
pred[ERASURE: UST]      0.26 0.20 -0.14  0.14  0.27  0.40  0.61      109
                       Tail_ESS Rhat
pred[ERASURE: PBO]           93 1.03
pred[ERASURE: ETN]          107 1.02
pred[ERASURE: IXE_Q2W]      132 1.02
pred[ERASURE: IXE_Q4W]      136 1.02
pred[ERASURE: SEC_150]       36 1.35
pred[ERASURE: SEC_300]       36 1.19
pred[ERASURE: UST]          106 1.01

---------------------------------------------------------------- Study: FEATURE ---- 

                        mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS
pred[FEATURE: PBO]     -4.17 0.35 -4.71 -4.42 -4.21 -3.96 -3.51       34
pred[FEATURE: ETN]     -2.66 0.35 -3.25 -2.89 -2.71 -2.44 -2.01       34
pred[FEATURE: IXE_Q2W] -1.22 0.33 -1.74 -1.46 -1.29 -0.98 -0.58       36
pred[FEATURE: IXE_Q4W] -1.65 0.34 -2.19 -1.88 -1.70 -1.42 -1.01       35
pred[FEATURE: SEC_150]  2.62 0.37  1.93  2.38  2.64  2.88  3.39        8
pred[FEATURE: SEC_300]  4.72 0.41  3.83  4.48  4.76  4.98  5.45       15
pred[FEATURE: UST]     -2.19 0.35 -2.85 -2.46 -2.21 -1.98 -1.48       39
                       Tail_ESS Rhat
pred[FEATURE: PBO]           42 1.11
pred[FEATURE: ETN]           22 1.14
pred[FEATURE: IXE_Q2W]       62 1.13
pred[FEATURE: IXE_Q4W]       47 1.15
pred[FEATURE: SEC_150]       24 1.20
pred[FEATURE: SEC_300]       81 1.11
pred[FEATURE: UST]          106 1.03

---------------------------------------------------------------- Study: FIXTURE ---- 

                        mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS
pred[FIXTURE: PBO]     -1.77 0.08 -1.95 -1.82 -1.76 -1.72 -1.62      158
pred[FIXTURE: ETN]     -0.12 0.06 -0.23 -0.16 -0.12 -0.08 -0.01      153
pred[FIXTURE: IXE_Q2W]  1.27 0.10  1.05  1.20  1.27  1.33  1.46       84
pred[FIXTURE: IXE_Q4W]  0.84 0.08  0.67  0.79  0.85  0.90  0.99      144
pred[FIXTURE: SEC_150]  2.62 0.29  2.08  2.46  2.63  2.81  3.19       13
pred[FIXTURE: SEC_300]  4.72 0.38  3.92  4.52  4.74  4.99  5.27       19
pred[FIXTURE: UST]      0.25 0.20 -0.13  0.10  0.26  0.40  0.56      101
                       Tail_ESS Rhat
pred[FIXTURE: PBO]          151 0.99
pred[FIXTURE: ETN]          167 1.01
pred[FIXTURE: IXE_Q2W]       90 1.01
pred[FIXTURE: IXE_Q4W]      160 1.01
pred[FIXTURE: SEC_150]       73 1.14
pred[FIXTURE: SEC_300]       54 1.21
pred[FIXTURE: UST]           97 1.01

---------------------------------------------------------------- Study: IXORA-S ---- 

                        mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS
pred[IXORA-S: PBO]     -1.44 0.20 -1.82 -1.59 -1.45 -1.32 -1.07       64
pred[IXORA-S: ETN]      0.19 0.20 -0.16  0.04  0.18  0.31  0.60       84
pred[IXORA-S: IXE_Q2W]  1.56 0.17  1.24  1.43  1.57  1.68  1.91       64
pred[IXORA-S: IXE_Q4W]  1.14 0.18  0.84  1.01  1.15  1.26  1.50       82
pred[IXORA-S: SEC_150]  4.22 0.53  3.24  3.79  4.28  4.65  5.06        4
pred[IXORA-S: SEC_300]  6.32 0.56  5.09  6.04  6.41  6.75  7.09        6
pred[IXORA-S: UST]      0.75 0.12  0.52  0.66  0.74  0.84  0.97      166
                       Tail_ESS Rhat
pred[IXORA-S: PBO]           66 1.01
pred[IXORA-S: ETN]           98 1.02
pred[IXORA-S: IXE_Q2W]       80 1.03
pred[IXORA-S: IXE_Q4W]       89 1.01
pred[IXORA-S: SEC_150]       29 1.58
pred[IXORA-S: SEC_300]       19 1.33
pred[IXORA-S: UST]          179 1.01

--------------------------------------------------------------- Study: JUNCTURE ---- 

                         mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS
pred[JUNCTURE: PBO]     -1.87 0.31 -2.51 -2.09 -1.84 -1.64 -1.35        6
pred[JUNCTURE: ETN]     -0.39 0.32 -1.03 -0.59 -0.36 -0.14  0.16        7
pred[JUNCTURE: IXE_Q2W]  1.05 0.32  0.40  0.87  1.05  1.30  1.61        7
pred[JUNCTURE: IXE_Q4W]  0.63 0.32  0.01  0.44  0.66  0.89  1.20        7
pred[JUNCTURE: SEC_150]  4.71 0.42  3.75  4.46  4.76  4.99  5.40        9
pred[JUNCTURE: SEC_300]  6.80 0.55  5.46  6.63  6.88  7.19  7.63       17
pred[JUNCTURE: UST]      0.09 0.39 -0.66 -0.17  0.13  0.34  0.76       12
                        Tail_ESS Rhat
pred[JUNCTURE: PBO]           38 1.26
pred[JUNCTURE: ETN]           39 1.24
pred[JUNCTURE: IXE_Q2W]       38 1.26
pred[JUNCTURE: IXE_Q4W]       43 1.24
pred[JUNCTURE: SEC_150]       24 1.18
pred[JUNCTURE: SEC_300]       35 1.24
pred[JUNCTURE: UST]           37 1.16

-------------------------------------------------------------- Study: UNCOVER-1 ---- 

                          mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS
pred[UNCOVER-1: PBO]     -1.61 0.08 -1.75 -1.66 -1.61 -1.57 -1.45      119
pred[UNCOVER-1: ETN]     -0.11 0.08 -0.25 -0.17 -0.12 -0.07  0.05      153
pred[UNCOVER-1: IXE_Q2W]  1.31 0.05  1.22  1.28  1.31  1.34  1.44       99
pred[UNCOVER-1: IXE_Q4W]  0.89 0.05  0.80  0.85  0.89  0.93  0.99      170
pred[UNCOVER-1: SEC_150]  4.98 0.51  3.95  4.73  5.03  5.36  5.74        6
pred[UNCOVER-1: SEC_300]  7.08 0.63  5.69  6.77  7.17  7.59  7.99       11
pred[UNCOVER-1: UST]      0.50 0.21  0.09  0.34  0.51  0.66  0.84      178
                         Tail_ESS Rhat
pred[UNCOVER-1: PBO]           79 1.00
pred[UNCOVER-1: ETN]           95 1.02
pred[UNCOVER-1: IXE_Q2W]       99 1.02
pred[UNCOVER-1: IXE_Q4W]      158 1.02
pred[UNCOVER-1: SEC_150]       17 1.26
pred[UNCOVER-1: SEC_300]       41 1.15
pred[UNCOVER-1: UST]          187 1.00

-------------------------------------------------------------- Study: UNCOVER-2 ---- 

                          mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS
pred[UNCOVER-2: PBO]     -1.72 0.06 -1.85 -1.76 -1.72 -1.68 -1.61       98
pred[UNCOVER-2: ETN]     -0.22 0.06 -0.35 -0.27 -0.22 -0.18 -0.10      114
pred[UNCOVER-2: IXE_Q2W]  1.20 0.06  1.10  1.16  1.21  1.25  1.32      113
pred[UNCOVER-2: IXE_Q4W]  0.78 0.06  0.67  0.74  0.78  0.83  0.90      191
pred[UNCOVER-2: SEC_150]  4.47 0.45  3.55  4.23  4.55  4.77  5.16        6
pred[UNCOVER-2: SEC_300]  6.57 0.58  5.32  6.26  6.62  7.03  7.46        9
pred[UNCOVER-2: UST]      0.32 0.21 -0.09  0.17  0.31  0.49  0.68      163
                         Tail_ESS Rhat
pred[UNCOVER-2: PBO]          111 1.00
pred[UNCOVER-2: ETN]           40 1.01
pred[UNCOVER-2: IXE_Q2W]      156 1.01
pred[UNCOVER-2: IXE_Q4W]      154 1.00
pred[UNCOVER-2: SEC_150]       19 1.27
pred[UNCOVER-2: SEC_300]       47 1.20
pred[UNCOVER-2: UST]          231 1.01

-------------------------------------------------------------- Study: UNCOVER-3 ---- 

                          mean   sd  2.5%   25%   50%   75% 97.5% Bulk_ESS
pred[UNCOVER-3: PBO]     -1.45 0.07 -1.58 -1.49 -1.44 -1.41 -1.33      101
pred[UNCOVER-3: ETN]      0.07 0.05 -0.02  0.03  0.07  0.11  0.18      177
pred[UNCOVER-3: IXE_Q2W]  1.49 0.07  1.36  1.45  1.49  1.54  1.64       89
pred[UNCOVER-3: IXE_Q4W]  1.07 0.06  0.96  1.03  1.08  1.11  1.18      205
pred[UNCOVER-3: SEC_150]  4.33 0.40  3.53  4.11  4.36  4.58  4.99        8
pred[UNCOVER-3: SEC_300]  6.43 0.53  5.27  6.13  6.48  6.84  7.26       12
pred[UNCOVER-3: UST]      0.54 0.21  0.15  0.39  0.55  0.70  0.90      110
                         Tail_ESS Rhat
pred[UNCOVER-3: PBO]          111 1.02
pred[UNCOVER-3: ETN]          105 1.01
pred[UNCOVER-3: IXE_Q2W]       22 1.03
pred[UNCOVER-3: IXE_Q4W]      106 1.03
pred[UNCOVER-3: SEC_150]       30 1.19
pred[UNCOVER-3: SEC_300]       52 1.24
pred[UNCOVER-3: UST]          183 1.01</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#marginal effects</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">marginal_effects</span>(pso_fit_FE, <span class="at">mtype =</span> <span class="st">"link"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>------------------------------------------------------------------ Study: CLEAR ---- 

                     mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS Rhat
marg[CLEAR: ETN]     1.55 0.07 1.44 1.50 1.53 1.59  1.70      140      129 1.00
marg[CLEAR: IXE_Q2W] 2.95 0.08 2.79 2.90 2.95 3.01  3.11       87      130 1.02
marg[CLEAR: IXE_Q4W] 2.53 0.08 2.38 2.48 2.53 2.58  2.68      138      129 1.00
marg[CLEAR: SEC_150] 1.83 0.18 1.49 1.71 1.83 1.95  2.21       65       79 1.04
marg[CLEAR: SEC_300] 2.29 0.18 1.94 2.17 2.31 2.41  2.62       49       88 1.07
marg[CLEAR: UST]     1.92 0.20 1.54 1.77 1.92 2.04  2.31       82      105 1.03

---------------------------------------------------------------- Study: ERASURE ---- 

                       mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
marg[ERASURE: ETN]     1.53 0.07 1.41 1.48 1.52 1.57  1.66      130      150
marg[ERASURE: IXE_Q2W] 2.92 0.09 2.77 2.87 2.93 2.98  3.08       92      106
marg[ERASURE: IXE_Q4W] 2.51 0.08 2.35 2.45 2.52 2.55  2.64      139      121
marg[ERASURE: SEC_150] 2.24 0.13 2.00 2.14 2.23 2.33  2.49       18      120
marg[ERASURE: SEC_300] 2.62 0.12 2.36 2.55 2.61 2.70  2.86      110       48
marg[ERASURE: UST]     1.96 0.19 1.59 1.85 1.97 2.08  2.34      106      137
                       Rhat
marg[ERASURE: ETN]     1.02
marg[ERASURE: IXE_Q2W] 1.02
marg[ERASURE: IXE_Q4W] 0.99
marg[ERASURE: SEC_150] 1.09
marg[ERASURE: SEC_300] 1.00
marg[ERASURE: UST]     1.02

---------------------------------------------------------------- Study: FEATURE ---- 

                       mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
marg[FEATURE: ETN]     1.54 0.08 1.39 1.48 1.54 1.60  1.69      132      142
marg[FEATURE: IXE_Q2W] 2.88 0.10 2.68 2.81 2.88 2.95  3.04       76       98
marg[FEATURE: IXE_Q4W] 2.46 0.09 2.28 2.40 2.48 2.52  2.62      139       79
marg[FEATURE: SEC_150] 4.44 0.32 3.80 4.24 4.49 4.65  4.95       31       74
marg[FEATURE: SEC_300] 4.81 0.32 4.19 4.59 4.82 5.02  5.36       34       40
marg[FEATURE: UST]     2.11 0.21 1.73 1.97 2.14 2.26  2.48       99      152
                       Rhat
marg[FEATURE: ETN]     1.04
marg[FEATURE: IXE_Q2W] 1.02
marg[FEATURE: IXE_Q4W] 1.01
marg[FEATURE: SEC_150] 1.15
marg[FEATURE: SEC_300] 1.12
marg[FEATURE: UST]     1.01

---------------------------------------------------------------- Study: FIXTURE ---- 

                       mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
marg[FIXTURE: ETN]     1.63 0.07 1.50 1.57 1.62 1.67  1.79      123      130
marg[FIXTURE: IXE_Q2W] 2.99 0.09 2.83 2.92 2.99 3.05  3.16       88      137
marg[FIXTURE: IXE_Q4W] 2.58 0.09 2.40 2.52 2.57 2.63  2.74      123      108
marg[FIXTURE: SEC_150] 2.14 0.08 1.99 2.09 2.14 2.20  2.30      131      120
marg[FIXTURE: SEC_300] 2.56 0.10 2.39 2.49 2.56 2.63  2.74       17      134
marg[FIXTURE: UST]     1.96 0.18 1.63 1.85 1.96 2.08  2.31       93      119
                       Rhat
marg[FIXTURE: ETN]     1.02
marg[FIXTURE: IXE_Q2W] 1.05
marg[FIXTURE: IXE_Q4W] 1.00
marg[FIXTURE: SEC_150] 1.00
marg[FIXTURE: SEC_300] 1.11
marg[FIXTURE: UST]     1.03

---------------------------------------------------------------- Study: IXORA-S ---- 

                       mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
marg[IXORA-S: ETN]     1.60 0.09 1.47 1.54 1.59 1.66  1.83      110       71
marg[IXORA-S: IXE_Q2W] 2.96 0.09 2.81 2.90 2.96 3.02  3.14       89       93
marg[IXORA-S: IXE_Q4W] 2.55 0.09 2.40 2.49 2.54 2.60  2.77      126       86
marg[IXORA-S: SEC_150] 2.02 0.20 1.63 1.92 2.02 2.15  2.38       47       64
marg[IXORA-S: SEC_300] 2.43 0.18 2.08 2.31 2.41 2.55  2.82       56       97
marg[IXORA-S: UST]     2.12 0.21 1.67 2.00 2.14 2.26  2.52       85       80
                       Rhat
marg[IXORA-S: ETN]     1.01
marg[IXORA-S: IXE_Q2W] 1.02
marg[IXORA-S: IXE_Q4W] 1.00
marg[IXORA-S: SEC_150] 1.07
marg[IXORA-S: SEC_300] 1.05
marg[IXORA-S: UST]     1.00

--------------------------------------------------------------- Study: JUNCTURE ---- 

                        mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
marg[JUNCTURE: ETN]     1.46 0.07 1.33 1.41 1.46 1.51  1.60      124       99
marg[JUNCTURE: IXE_Q2W] 2.86 0.09 2.70 2.80 2.87 2.93  3.01       89      107
marg[JUNCTURE: IXE_Q4W] 2.45 0.08 2.28 2.39 2.46 2.51  2.58      129      107
marg[JUNCTURE: SEC_150] 2.51 0.30 2.02 2.29 2.46 2.72  3.18        6       22
marg[JUNCTURE: SEC_300] 2.90 0.32 2.38 2.66 2.85 3.16  3.57        4       19
marg[JUNCTURE: UST]     1.90 0.21 1.51 1.76 1.89 2.03  2.30      100       78
                        Rhat
marg[JUNCTURE: ETN]     1.01
marg[JUNCTURE: IXE_Q2W] 1.01
marg[JUNCTURE: IXE_Q4W] 1.01
marg[JUNCTURE: SEC_150] 1.31
marg[JUNCTURE: SEC_300] 1.42
marg[JUNCTURE: UST]     1.00

-------------------------------------------------------------- Study: UNCOVER-1 ---- 

                         mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
marg[UNCOVER-1: ETN]     1.47 0.07 1.36 1.42 1.47 1.53  1.60      150      136
marg[UNCOVER-1: IXE_Q2W] 2.87 0.08 2.72 2.81 2.87 2.93  3.01       90      130
marg[UNCOVER-1: IXE_Q4W] 2.46 0.07 2.31 2.41 2.46 2.50  2.58      147      106
marg[UNCOVER-1: SEC_150] 2.29 0.09 2.11 2.24 2.28 2.35  2.47       11       62
marg[UNCOVER-1: SEC_300] 2.64 0.12 2.41 2.57 2.62 2.71  2.94        6       27
marg[UNCOVER-1: UST]     2.02 0.19 1.64 1.91 2.02 2.17  2.38      103      109
                         Rhat
marg[UNCOVER-1: ETN]     1.01
marg[UNCOVER-1: IXE_Q2W] 1.00
marg[UNCOVER-1: IXE_Q4W] 1.02
marg[UNCOVER-1: SEC_150] 1.13
marg[UNCOVER-1: SEC_300] 1.32
marg[UNCOVER-1: UST]     1.01

-------------------------------------------------------------- Study: UNCOVER-2 ---- 

                         mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
marg[UNCOVER-2: ETN]     1.47 0.07 1.36 1.42 1.47 1.52  1.61      139      117
marg[UNCOVER-2: IXE_Q2W] 2.87 0.08 2.71 2.81 2.87 2.93  3.01       97      115
marg[UNCOVER-2: IXE_Q4W] 2.46 0.08 2.31 2.41 2.47 2.51  2.59      144      106
marg[UNCOVER-2: SEC_150] 2.37 0.09 2.22 2.31 2.36 2.42  2.56        8       32
marg[UNCOVER-2: SEC_300] 2.73 0.11 2.56 2.65 2.71 2.78  2.98        8       28
marg[UNCOVER-2: UST]     1.96 0.19 1.59 1.85 1.95 2.09  2.35      103       90
                         Rhat
marg[UNCOVER-2: ETN]     1.01
marg[UNCOVER-2: IXE_Q2W] 1.01
marg[UNCOVER-2: IXE_Q4W] 1.01
marg[UNCOVER-2: SEC_150] 1.20
marg[UNCOVER-2: SEC_300] 1.23
marg[UNCOVER-2: UST]     1.01

-------------------------------------------------------------- Study: UNCOVER-3 ---- 

                         mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
marg[UNCOVER-3: ETN]     1.49 0.07 1.38 1.44 1.49 1.54  1.63      133      132
marg[UNCOVER-3: IXE_Q2W] 2.89 0.09 2.73 2.83 2.90 2.96  3.03       97       96
marg[UNCOVER-3: IXE_Q4W] 2.48 0.08 2.32 2.43 2.49 2.53  2.60      149      122
marg[UNCOVER-3: SEC_150] 2.06 0.08 1.94 2.01 2.05 2.11  2.24       13       33
marg[UNCOVER-3: SEC_300] 2.46 0.10 2.30 2.39 2.45 2.51  2.73        9       23
marg[UNCOVER-3: UST]     1.90 0.20 1.54 1.77 1.89 2.02  2.29       96       64
                         Rhat
marg[UNCOVER-3: ETN]     1.00
marg[UNCOVER-3: IXE_Q2W] 1.01
marg[UNCOVER-3: IXE_Q4W] 1.00
marg[UNCOVER-3: SEC_150] 1.14
marg[UNCOVER-3: SEC_300] 1.21
marg[UNCOVER-3: UST]     1.02</code></pre>
</div>
</div>
<p>If we are interest in estimates for a specific target population (PROSPECT), we require a data frame containing the related covariate summary information, which can then be used to generate population-average conditional treatment effects using the <code>relative_effects()</code> function and setting the argument <code>all_contrasts = TRUE</code> to estimate every pairwise comparison.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set up agg target pop data set</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>prospect_dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">studyc =</span> <span class="st">"PROSPECT"</span>,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">durnpso =</span> <span class="fl">19.6</span> <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">durnpso_sd =</span> <span class="fl">13.5</span> <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">prevsys =</span> <span class="fl">0.9095</span>,</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bsa =</span> <span class="fl">18.7</span> <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bsa_sd =</span> <span class="fl">18.4</span> <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">weight =</span> <span class="fl">87.5</span> <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">weight_sd =</span> <span class="fl">20.3</span> <span class="sc">/</span> <span class="dv">100</span>,</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">psa =</span> <span class="fl">0.202</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a><span class="co">#compute relative effects</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="fu">relative_effects</span>(pso_fit_FE, </span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>                 <span class="at">newdata =</span> prospect_dat,</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>                 <span class="at">study =</span> studyc,</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">all_contrasts =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>--------------------------------------------------------------- Study: PROSPECT ---- 

Covariate values:
 durnpso prevsys  bsa weight psa
    1.96    0.91 0.19   0.88 0.2

                                   mean   sd   2.5%    25%   50%   75% 97.5%
d[PROSPECT: ETN vs. PBO]           2.94 0.28   2.44   2.77  2.92  3.12  3.45
d[PROSPECT: IXE_Q2W vs. PBO]       3.71 0.27   3.17   3.53  3.71  3.92  4.24
d[PROSPECT: IXE_Q4W vs. PBO]       3.29 0.27   2.80   3.12  3.27  3.50  3.89
d[PROSPECT: SEC_150 vs. PBO]      -7.23 4.25 -14.12 -11.68 -5.51 -3.46 -1.50
d[PROSPECT: SEC_300 vs. PBO]      -5.13 4.32 -11.98  -9.68 -3.35 -1.29  0.75
d[PROSPECT: UST vs. PBO]           2.95 0.46   2.01   2.66  2.98  3.23  3.88
d[PROSPECT: IXE_Q2W vs. ETN]       0.77 0.21   0.35   0.64  0.77  0.93  1.18
d[PROSPECT: IXE_Q4W vs. ETN]       0.35 0.20  -0.04   0.23  0.36  0.47  0.76
d[PROSPECT: SEC_150 vs. ETN]     -10.17 4.32 -17.28 -14.78 -8.37 -6.26 -4.21
d[PROSPECT: SEC_300 vs. ETN]      -8.07 4.39 -15.06 -12.80 -6.27 -4.14 -1.80
d[PROSPECT: UST vs. ETN]           0.01 0.45  -0.88  -0.25 -0.03  0.25  1.00
d[PROSPECT: IXE_Q4W vs. IXE_Q2W]  -0.42 0.07  -0.54  -0.47 -0.42 -0.38 -0.27
d[PROSPECT: SEC_150 vs. IXE_Q2W] -10.94 4.31 -17.95 -15.51 -9.27 -6.99 -5.00
d[PROSPECT: SEC_300 vs. IXE_Q2W]  -8.84 4.38 -15.94 -13.53 -7.12 -4.92 -2.65
d[PROSPECT: UST vs. IXE_Q2W]      -0.76 0.44  -1.75  -0.99 -0.75 -0.50  0.08
d[PROSPECT: SEC_150 vs. IXE_Q4W] -10.52 4.30 -17.53 -15.06 -8.86 -6.59 -4.67
d[PROSPECT: SEC_300 vs. IXE_Q4W]  -8.42 4.37 -15.61 -13.07 -6.70 -4.45 -2.24
d[PROSPECT: UST vs. IXE_Q4W]      -0.34 0.45  -1.36  -0.60 -0.33 -0.04  0.53
d[PROSPECT: SEC_300 vs. SEC_150]   2.10 0.29   1.56   1.91  2.07  2.31  2.70
d[PROSPECT: UST vs. SEC_150]      10.18 4.30   4.13   6.28  8.84 14.63 17.30
d[PROSPECT: UST vs. SEC_300]       8.08 4.37   1.85   4.12  6.64 12.70 15.42
                                 Bulk_ESS Tail_ESS Rhat
d[PROSPECT: ETN vs. PBO]               34      155 1.07
d[PROSPECT: IXE_Q2W vs. PBO]           69       37 1.04
d[PROSPECT: IXE_Q4W vs. PBO]           68       77 1.05
d[PROSPECT: SEC_150 vs. PBO]            3       37 1.90
d[PROSPECT: SEC_300 vs. PBO]            3       32 1.93
d[PROSPECT: UST vs. PBO]              172      106 1.01
d[PROSPECT: IXE_Q2W vs. ETN]          133      154 1.00
d[PROSPECT: IXE_Q4W vs. ETN]          146      149 1.00
d[PROSPECT: SEC_150 vs. ETN]            3       33 1.89
d[PROSPECT: SEC_300 vs. ETN]            3       32 1.92
d[PROSPECT: UST vs. ETN]              178       94 1.02
d[PROSPECT: IXE_Q4W vs. IXE_Q2W]      130       56 1.08
d[PROSPECT: SEC_150 vs. IXE_Q2W]        3       33 1.90
d[PROSPECT: SEC_300 vs. IXE_Q2W]        3       32 1.94
d[PROSPECT: UST vs. IXE_Q2W]          178       94 1.00
d[PROSPECT: SEC_150 vs. IXE_Q4W]        3       33 1.90
d[PROSPECT: SEC_300 vs. IXE_Q4W]        3       32 1.93
d[PROSPECT: UST vs. IXE_Q4W]          175       94 1.01
d[PROSPECT: SEC_300 vs. SEC_150]       20       96 1.11
d[PROSPECT: UST vs. SEC_150]            3       37 1.91
d[PROSPECT: UST vs. SEC_300]            3       34 1.93</code></pre>
</div>
</div>
<p>To produce absolute event probabilities, we first need to set up numerical integration for the target population, in this case using the same forms of the marginal distributions and individual-level covariance matrix stored in the network object. Next, we also need a distribution for the baseline risk, typically by assuming a distribution on the average response probability (here assumed to follow a Beta distribution). We can then also plot the predicted probabilities, as shown in <a href="#fig-mlnmr2" class="quarto-xref">Figure&nbsp;6</a>, using the <code>plot</code> function.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set up data for integration and compute absolute event probs</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>prospect_dat <span class="ot">&lt;-</span> <span class="fu">add_integration</span>(prospect_dat,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">durnpso =</span> <span class="fu">distr</span>(qgamma, <span class="at">mean =</span> durnpso, <span class="at">sd =</span> durnpso_sd),</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">prevsys =</span> <span class="fu">distr</span>(qbern, <span class="at">prob =</span> prevsys),</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">bsa =</span> <span class="fu">distr</span>(qlogitnorm, <span class="at">mean =</span> bsa, <span class="at">sd =</span> bsa_sd),</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">weight =</span> <span class="fu">distr</span>(qgamma, <span class="at">mean =</span> weight, <span class="at">sd =</span> weight_sd),</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">psa =</span> <span class="fu">distr</span>(qbern, <span class="at">prob =</span> psa),</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">cor =</span> pso_net<span class="sc">$</span>int_cor)</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>prospect_prec <span class="ot">&lt;-</span> <span class="fu">predict</span>(pso_fit_FE,</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">newdata =</span> prospect_dat,</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">study =</span> studyc,</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline =</span> <span class="fu">distr</span>(qbeta, <span class="dv">1156</span>, <span class="dv">1509-1156</span>),</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline_type =</span> <span class="st">"response"</span>,</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline_level =</span> <span class="st">"aggregate"</span>,</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline_trt =</span> <span class="st">"SEC_300"</span>)</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a><span class="co">#show results</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>prospect_prec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>--------------------------------------------------------------- Study: PROSPECT ---- 

                        mean   sd 2.5%  25%  50%  75% 97.5% Bulk_ESS Tail_ESS
pred[PROSPECT: PBO]     1.00 0.00 1.00 1.00 1.00 1.00  1.00        3       NA
pred[PROSPECT: ETN]     1.00 0.00 1.00 1.00 1.00 1.00  1.00       10       NA
pred[PROSPECT: IXE_Q2W] 1.00 0.00 1.00 1.00 1.00 1.00  1.00       17       NA
pred[PROSPECT: IXE_Q4W] 1.00 0.00 1.00 1.00 1.00 1.00  1.00       15       NA
pred[PROSPECT: SEC_150] 0.56 0.05 0.45 0.53 0.57 0.60  0.63        3       21
pred[PROSPECT: SEC_300] 0.76 0.01 0.74 0.76 0.77 0.77  0.78       60      157
pred[PROSPECT: UST]     1.00 0.00 1.00 1.00 1.00 1.00  1.00        7       NA
                        Rhat
pred[PROSPECT: PBO]     2.12
pred[PROSPECT: ETN]     1.24
pred[PROSPECT: IXE_Q2W] 1.15
pred[PROSPECT: IXE_Q4W] 1.18
pred[PROSPECT: SEC_150] 1.81
pred[PROSPECT: SEC_300] 1.03
pred[PROSPECT: UST]     1.34</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">#plot results</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prospect_prec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mlnmr2" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mlnmr2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="code3_files/figure-html/fig-mlnmr2-1.png" id="fig-mlnmr2" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-mlnmr2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6
</figcaption>
</figure>
</div>
</div>
</div>
<p>These probabilities can be used to generate population-average marginal treatment effects on a selected scale (here probit).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get marginal trt effects</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">marginal_effects</span>(pso_fit_FE,</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtype =</span> <span class="st">"link"</span>, <span class="co">#probit scale</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> prospect_dat,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">study =</span> studyc,</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline =</span> <span class="fu">distr</span>(qbeta, <span class="dv">1156</span>, <span class="dv">1509-1156</span>),</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_type =</span> <span class="st">"response"</span>,</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_level =</span> <span class="st">"aggregate"</span>,</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_trt =</span> <span class="st">"SEC_300"</span>)</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="co">#results not shown here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Population-adjusted methods ar increasingly used in HTA submissions, where manufacturers have individual-level data from their own studies but only aggregate-level data from studies of their competitors. Currently, ML-NMR is then only approach that can produce estimates in any target population of interest. Estimates of population-average treatment effects are required for decision-making, but marginal and conditional effects do not generally coincide. For CE decisions, the relevant estimand is the expected net benefit over the population which, in the presence of heterogeneous treatment effects, should be accounted for in a suitable economic model. The outputs from population-adjusted analyses are then the inputs to the economic model, often defined in terms of absolute effects on each treatment. Unanchored indirect comparisons rely on very strong assumptions that all effect-modifiers and prognostic factors in imbalance between studies have been accounted, which if violated lead to biased estimates.</p>
</section>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-berlin2002individual" class="csl-entry" role="listitem">
Berlin, Jesse A, Jill Santanna, Christopher H Schmid, Lynda A Szczech, and Harold I Feldman. 2002. <span>“Individual Patient-Versus Group-Level Data Meta-Regressions for the Investigation of Treatment Effect Modifiers: Ecological Bias Rears Its Ugly Head.”</span> <em>Statistics in Medicine</em> 21 (3): 371–87.
</div>
<div id="ref-caro2010no" class="csl-entry" role="listitem">
Caro, J Jaime, and K Jack Ishak. 2010. <span>“No Head-to-Head Trial? Simulate the Missing Arms.”</span> <em>Pharmacoeconomics</em> 28 (10): 957–67.
</div>
<div id="ref-el2022scoping" class="csl-entry" role="listitem">
El Alili, Mohamed, Johanna M van Dongen, Jonas L Esser, Martijn W Heymans, Maurits W van Tulder, and Judith E Bosmans. 2022. <span>“A Scoping Review of Statistical Methods for Trial-Based Economic Evaluations: The Current State of Play.”</span> <em>Health Economics</em> 31 (12): 2680–99.
</div>
<div id="ref-faria2015nice" class="csl-entry" role="listitem">
Faria, Rita, Monica Hernandez Alava, Andrea Manca, and Allan J Wailoo. 2015. <span>“Nice Dsu Technical Support Document 17: The Use of Observational Data to Inform Estimates of Treatment Effectiveness in Technology Appraisal.”</span>
</div>
<div id="ref-national2022nice" class="csl-entry" role="listitem">
Health, National Institute for, and Care Excellence. 2022. <span>“NICE Health Technology Evaluations: The Manual.”</span> <em>Process and Methods [PMG36]</em>.
</div>
<div id="ref-hunter2021using" class="csl-entry" role="listitem">
Hunter, Elizabeth, and John D Kelleher. 2021. <span>“Using a Hybrid Agent-Based and Equation Based Model to Test School Closure Policies During a Measles Outbreak.”</span> <em>BMC Public Health</em> 21 (1): 499.
</div>
<div id="ref-ishak2015simulation" class="csl-entry" role="listitem">
Ishak, K Jack, Irina Proskorovsky, and Agnes Benedict. 2015. <span>“Simulation and Matching-Based Approaches for Indirect Comparison of Treatments.”</span> <em>Pharmacoeconomics</em> 33 (6): 537–49.
</div>
<div id="ref-jackson2011multi" class="csl-entry" role="listitem">
Jackson, Christopher. 2011. <span>“Multi-State Models for Panel Data: The Msm Package for r.”</span> <em>Journal of Statistical Software</em> 38: 1–28.
</div>
<div id="ref-karnon2014use" class="csl-entry" role="listitem">
Karnon, Jonathan, and Hossein Haji Ali Afzali. 2014. <span>“When to Use Discrete Event Simulation (DES) for the Economic Evaluation of Health Technologies? A Review and Critique of the Costs and Benefits of DES.”</span> <em>Pharmacoeconomics</em> 32 (6): 547–58.
</div>
<div id="ref-moertel1990levamisole" class="csl-entry" role="listitem">
Moertel, Charles G, Thomas R Fleming, John S Macdonald, Daniel G Haller, John A Laurie, Phyllis J Goodman, James S Ungerleider, et al. 1990. <span>“Levamisole and Fluorouracil for Adjuvant Therapy of Resected Colon Carcinoma.”</span> <em>New England Journal of Medicine</em> 322 (6): 352–58.
</div>
<div id="ref-nederland2024guideline" class="csl-entry" role="listitem">
Nederland, Zorginstituut. 2024. <span>“Guideline for Economic Evaluations in Healthcare (2024 Version).”</span> <em>Zorginstituut Nederland: Diemen</em>.
</div>
<div id="ref-phillippo2018methods" class="csl-entry" role="listitem">
Phillippo, David M, Anthony E Ades, Sofia Dias, Stephen Palmer, Keith R Abrams, and Nicky J Welton. 2018. <span>“Methods for Population-Adjusted Indirect Comparisons in Health Technology Appraisal.”</span> <em>Medical Decision Making</em> 38 (2): 200–211.
</div>
<div id="ref-phillippo2020multilevel" class="csl-entry" role="listitem">
Phillippo, David M, Sofia Dias, AE Ades, Mark Belger, Alan Brnabic, Alexander Schacht, Daniel Saure, Zbigniew Kadziola, and Nicky J Welton. 2020. <span>“Multilevel Network Meta-Regression for Population-Adjusted Treatment Comparisons.”</span> <em>Journal of the Royal Statistical Society Series A: Statistics in Society</em> 183 (3): 1189–1210.
</div>
<div id="ref-siebert2012state" class="csl-entry" role="listitem">
Siebert, Uwe, Oguzhan Alagoz, Ahmed M Bayoumi, Beate Jahn, Douglas K Owens, David J Cohen, and Karen M Kuntz. 2012. <span>“State-Transition Modeling: A Report of the ISPOR-SMDM Modeling Good Research Practices Task Force–3.”</span> <em>Medical Decision Making</em> 32 (5): 690–700.
</div>
<div id="ref-thacci2020secukinumab" class="csl-entry" role="listitem">
Thaçi, D, A Körber, R von Kiedrowski, T Bachhuber, N Melzer, T Kasparek, E Duetting, G Kraehn-Senftleben, U Amon, and M Augustin. 2020. <span>“Secukinumab Is Effective in Treatment of Moderate-to-Severe Plaque Psoriasis: Real-Life Effectiveness and Safety from the PROSPECT Study.”</span> <em>Journal of the European Academy of Dermatology and Venereology</em> 34 (2): 310–18.
</div>
<div id="ref-woods2017nice" class="csl-entry" role="listitem">
Woods, Bethan Sarah, Eleftherios Sideris, Stephen John Palmer, Nicholas Latimer, and Marta Ferreira Oliveira Soares. 2017. <span>“NICE DSU Technical Support Document 19:: Partitioned Survival Analysis for Decision Modelling in Health Care: A Critical Review.”</span>
</div>
<div id="ref-de2011mstate" class="csl-entry" role="listitem">
Wreede, Liesbeth C de, Marta Fiocco, and Hein Putter. 2011. <span>“Mstate: An r Package for the Analysis of Competing Risks and Multi-State Models.”</span> <em>Journal of Statistical Software</em> 38: 1–30.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>